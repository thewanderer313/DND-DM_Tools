<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Oakhart Roll Tables</title>
  <style>
    :root {
      --bg-primary: #111816;
      --bg-secondary: #161f1b;
      --bg-tertiary: #1c2723;
      --bg-card: #212d28;
      --border-color: #2a3832;
      --border-strong: #3a4a42;
      --text-primary: #e4ebe4;
      --text-secondary: #9aaa9a;
      --text-muted: #5a6a5a;
      --accent: #4a7c59;
      --accent-hover: #5a9469;
      --accent-glow: rgba(74, 124, 89, 0.25);
      --danger: #8b3a3a;
      --danger-hover: #a04545;
      --warning: #8b7355;
      --success: #4a7c59;
      --shadow: rgba(0, 0, 0, 0.5);
      --overlay: rgba(17, 24, 22, 0.88);
      --section-gap: 2px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }

    #app-background {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      z-index: -2;
    }

    #app-background::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--overlay);
      z-index: -1;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      position: relative;
    }

    /* Header */
    .app-header {
      background: var(--bg-secondary);
      border-bottom: 2px solid var(--border-strong);
      padding: 0.5rem 0.875rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .app-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .app-title svg {
      width: 20px;
      height: 20px;
      fill: var(--accent);
    }

    .header-actions {
      display: flex;
      gap: 0.375rem;
    }

    .help-btn {
      background: transparent;
      border: 1px solid var(--border-color);
      width: 28px;
      height: 28px;
      padding: 0;
      border-radius: 50%;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .help-btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Buttons */
    button {
      font-family: inherit;
      font-size: 0.75rem;
      padding: 0.375rem 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.12s ease;
    }

    button:hover {
      background: var(--bg-card);
      border-color: var(--border-strong);
    }

    button:focus {
      outline: 1px solid var(--accent);
      outline-offset: 1px;
    }

    button.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    button.primary:hover {
      background: var(--accent-hover);
      border-color: var(--accent-hover);
    }

    button.danger {
      background: var(--danger);
      border-color: var(--danger);
      color: white;
    }

    button.danger:hover {
      background: var(--danger-hover);
      border-color: var(--danger-hover);
    }

    button.small {
      padding: 0.2rem 0.4rem;
      font-size: 0.6875rem;
    }

    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    #images-folder-status {
      padding: 0.5rem;
      border-radius: 4px;
      background: var(--bg-tertiary);
    }

    #images-folder-status.active {
      color: var(--success);
      background: rgba(100, 180, 100, 0.15);
    }

    /* Main Layout */
    .main-content {
      display: grid;
      grid-template-columns: minmax(140px, 180px) minmax(180px, 260px) 1fr;
      flex: 1;
      overflow: hidden;
      gap: var(--section-gap);
      background: var(--border-color);
    }

    .column {
      display: flex;
      flex-direction: column;
      background: var(--bg-primary);
      overflow: hidden;
    }

    .column-header {
      padding: 0.6rem 0.875rem;
      background: var(--bg-secondary);
      border-bottom: 2px solid var(--border-strong);
      font-weight: 600;
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .step-badge {
      background: var(--accent);
      color: white;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.625rem;
      font-weight: 700;
      flex-shrink: 0;
    }

    .step-badge.waiting {
      background: var(--bg-card);
      color: var(--text-muted);
    }

    .column-add-btn {
      margin-left: auto;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      width: 20px;
      height: 20px;
      padding: 0;
      border-radius: 4px;
      font-size: 0.875rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.12s ease;
    }

    .column-add-btn:hover {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    /* Selection breadcrumb */
    .selection-bar {
      background: var(--bg-secondary);
      border-bottom: 2px solid var(--border-strong);
      padding: 0.4rem 0.875rem;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-shrink: 0;
    }

    .selection-bar-label {
      color: var(--text-muted);
    }

    .selection-bar-value {
      color: var(--accent);
      font-weight: 500;
    }

    .selection-bar-separator {
      color: var(--text-muted);
    }

    .column-content {
      flex: 1;
      overflow-y: auto;
      padding: 0.375rem;
    }

    /* Lists */
    .list-item {
      padding: 0.5rem 0.625rem;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.12s ease;
      margin-bottom: 1px;
      border: 1px solid transparent;
    }

    .list-item:hover {
      background: var(--bg-tertiary);
    }

    .list-item.selected {
      background: var(--bg-card);
      border-color: var(--accent);
    }

    .list-item-title {
      font-size: 0.8125rem;
      font-weight: 500;
    }

    .list-item-meta {
      font-size: 0.6875rem;
      color: var(--text-muted);
      margin-top: 1px;
    }

    /* Search Box */
    .search-box {
      padding: 0.375rem;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-secondary);
      flex-shrink: 0;
    }

    .search-box input {
      width: 100%;
      padding: 0.375rem 0.625rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 0.8125rem;
    }

    .search-box input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .search-box input::placeholder {
      color: var(--text-muted);
    }

    /* Tables Column */
    .table-info {
      padding: 0.75rem;
      background: var(--bg-tertiary);
      border-radius: 8px;
      margin-bottom: 0.75rem;
    }

    .table-info-name {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 0.25rem;
    }

    .table-info-dice {
      font-size: 0.875rem;
      color: var(--accent);
      font-weight: 500;
    }

    .roll-controls {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .roll-controls button.roll-btn {
      flex: 1;
      padding: 0.75rem;
      font-size: 1rem;
      font-weight: 600;
    }

    .manual-roll {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .manual-roll input {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 0.875rem;
      text-align: center;
    }

    .manual-roll input:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Results Panel */
    .results-column {
      display: flex;
      flex-direction: column;
    }

    .current-result {
      padding: 0.75rem;
      border-bottom: 2px solid var(--border-strong);
      flex-shrink: 0;
      background: var(--bg-secondary);
    }

    .result-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 0.875rem;
      position: relative;
    }

    .result-card.has-image {
      cursor: pointer;
    }

    .result-card.has-image:hover {
      border-color: var(--accent);
    }

    .result-roll-number {
      position: absolute;
      top: -6px;
      right: 10px;
      background: var(--accent);
      color: white;
      padding: 0.1rem 0.4rem;
      border-radius: 3px;
      font-size: 0.6875rem;
      font-weight: 600;
    }

    .result-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.375rem;
    }

    .result-body {
      font-size: 0.8125rem;
      color: var(--text-secondary);
      white-space: pre-wrap;
      line-height: 1.5;
    }

    .result-effects {
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid var(--border-color);
      font-size: 0.75rem;
      color: var(--warning);
      font-style: italic;
    }

    .result-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      margin-top: 0.5rem;
    }

    .tag {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      padding: 0.1rem 0.375rem;
      border-radius: 3px;
      font-size: 0.6875rem;
      color: var(--text-muted);
    }

    .result-image-preview {
      width: 100%;
      max-height: 160px;
      object-fit: cover;
      border-radius: 4px;
      margin-bottom: 0.5rem;
    }

    .click-hint {
      font-size: 0.6875rem;
      color: var(--text-muted);
      text-align: center;
      margin-top: 0.375rem;
    }

    /* Follow-up Suggestions */
    .follow-up-tables {
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid var(--border-color);
    }

    .follow-up-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 0.375rem;
    }

    .follow-up-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.375rem;
    }

    .follow-up-chip {
      background: var(--bg-tertiary);
      border: 1px solid var(--accent);
      padding: 0.25rem 0.625rem;
      border-radius: 16px;
      font-size: 0.75rem;
      color: var(--accent);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .follow-up-chip:hover {
      background: var(--accent);
      color: white;
    }

    /* Entries List */
    .entries-header {
      padding: 0.4rem 0.625rem;
      background: var(--bg-secondary);
      border-top: 2px solid var(--border-strong);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-shrink: 0;
    }

    .entries-title {
      font-weight: 600;
      font-size: 0.6875rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .entries-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.375rem;
      background: var(--bg-primary);
    }

    .entry-item {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.35rem 0.5rem;
      background: var(--bg-tertiary);
      border: 1px solid transparent;
      border-radius: 4px;
      margin-bottom: 0.2rem;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.12s ease;
    }

    .entry-item:hover {
      border-color: var(--border-strong);
      background: var(--bg-card);
    }

    .entry-item.editing {
      border-color: var(--accent);
      background: var(--bg-card);
    }

    .entry-item-number {
      color: var(--text-muted);
      font-size: 0.625rem;
      min-width: 18px;
    }

    .entry-item-title {
      flex: 1;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .entry-item-image {
      color: var(--accent);
      font-size: 0.625rem;
    }

    .entry-item-actions {
      display: flex;
      gap: 0.2rem;
      opacity: 0;
      transition: opacity 0.12s ease;
    }

    .entry-item:hover .entry-item-actions {
      opacity: 1;
    }

    .entry-item-actions button {
      padding: 0.15rem 0.25rem;
      font-size: 0.625rem;
      min-width: 20px;
    }

    .empty-state-small {
      padding: 1rem;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    /* Dice Roller Widget */
    .dice-roller {
      padding: 0.5rem 0.75rem;
      background: var(--bg-secondary);
      border-top: 2px solid var(--border-strong);
      flex-shrink: 0;
    }

    .dice-roller-title {
      font-size: 0.625rem;
      color: var(--text-muted);
      margin-bottom: 0.375rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .dice-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
    }

    .dice-btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.6875rem;
      min-width: 36px;
    }

    .dice-result {
      margin-top: 0.375rem;
      padding: 0.375rem;
      background: var(--bg-tertiary);
      border-radius: 4px;
      text-align: center;
      font-size: 0.8125rem;
      min-height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
    }

    /* Table Editor Slide Panel */
    .table-editor-panel {
      position: fixed;
      top: 0;
      right: -500px;
      width: 480px;
      max-width: 100%;
      height: 100vh;
      background: var(--bg-secondary);
      border-left: 1px solid var(--border-color);
      z-index: 900;
      display: flex;
      flex-direction: column;
      transition: right 0.3s ease;
      box-shadow: -4px 0 20px var(--shadow);
    }

    .table-editor-panel.active {
      right: 0;
    }

    .table-editor-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-tertiary);
    }

    .table-editor-title {
      font-size: 1.125rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .table-editor-title .entry-count-badge {
      background: var(--accent);
      color: white;
      padding: 0.125rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .table-editor-body {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .table-editor-footer {
      padding: 1rem;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 0.5rem;
    }

    /* Quick Entry List */
    .quick-entry-list {
      margin-bottom: 0.75rem;
    }

    .quick-entry-item {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.4rem 0.5rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      margin-bottom: 0.25rem;
      transition: all 0.12s ease;
    }

    .quick-entry-item:hover {
      border-color: var(--border-strong);
    }

    .quick-entry-item.editing {
      border-color: var(--accent);
    }

    .quick-entry-number {
      background: var(--bg-card);
      color: var(--text-muted);
      padding: 0.15rem 0.35rem;
      border-radius: 3px;
      font-size: 0.6875rem;
      font-weight: 600;
      min-width: 24px;
      text-align: center;
    }

    .quick-entry-type {
      font-size: 0.625rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0.125rem 0.375rem;
      border-radius: 3px;
      font-weight: 600;
    }

    .quick-entry-type.text {
      background: var(--bg-card);
      color: var(--text-muted);
    }

    .quick-entry-type.card {
      background: var(--accent);
      color: white;
    }

    .quick-entry-preview {
      flex: 1;
      font-size: 0.8125rem;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
    }

    .quick-entry-preview:hover {
      color: var(--text-primary);
    }

    .quick-entry-image-indicator {
      color: var(--accent);
      font-size: 0.75rem;
    }

    .quick-entry-actions {
      display: flex;
      gap: 0.25rem;
      opacity: 0.6;
      transition: opacity 0.15s ease;
    }

    .quick-entry-item:hover .quick-entry-actions {
      opacity: 1;
    }

    .quick-entry-actions button {
      padding: 0.25rem;
      min-width: 28px;
      font-size: 0.75rem;
    }

    /* Inline Entry Editor */
    .inline-entry-editor {
      background: var(--bg-card);
      border: 1px solid var(--accent);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 12px var(--accent-glow);
    }

    .inline-editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border-color);
    }

    .inline-editor-title {
      font-weight: 600;
      font-size: 0.9375rem;
    }

    .inline-editor-tabs {
      display: flex;
      gap: 0.25rem;
      margin-bottom: 1rem;
    }

    .inline-editor-tab {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s ease;
      font-size: 0.8125rem;
    }

    .inline-editor-tab:first-child {
      border-radius: 6px 0 0 6px;
    }

    .inline-editor-tab:last-child {
      border-radius: 0 6px 6px 0;
    }

    .inline-editor-tab.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    .inline-editor-tab:hover:not(.active) {
      background: var(--bg-card);
    }

    .inline-editor-fields {
      display: none;
    }

    .inline-editor-fields.active {
      display: block;
    }

    .inline-form-group {
      margin-bottom: 0.875rem;
    }

    .inline-form-label {
      display: block;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.375rem;
    }

    .inline-form-input,
    .inline-form-textarea,
    .inline-form-select {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 0.875rem;
      font-family: inherit;
    }

    .inline-form-input:focus,
    .inline-form-textarea:focus,
    .inline-form-select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .inline-form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    .inline-form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }

    .inline-image-upload {
      border: 2px dashed var(--border-color);
      border-radius: 6px;
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.15s ease;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .inline-image-upload:hover {
      border-color: var(--accent);
      background: var(--bg-tertiary);
    }

    .inline-image-upload.has-image {
      padding: 0.5rem;
    }

    .inline-image-upload img {
      max-width: 100%;
      max-height: 120px;
      border-radius: 4px;
    }

    .inline-image-upload-text {
      color: var(--text-muted);
      font-size: 0.8125rem;
    }

    .inline-editor-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--border-color);
    }

    .edit-table-btn {
      margin-top: 0.5rem;
    }

    /* Add entry button */
    .add-entry-section {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .add-entry-section button {
      flex: 1;
    }

    /* Panel backdrop */
    .panel-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 850;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .panel-backdrop.active {
      opacity: 1;
      visibility: visible;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      max-width: 90%;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px var(--shadow);
      transform: scale(0.95);
      transition: transform 0.2s ease;
    }

    .modal-overlay.active .modal {
      transform: scale(1);
    }

    .modal-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 1.125rem;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    .modal-body {
      padding: 1rem;
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      padding: 1rem;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }

    /* Card Modal */
    .card-modal {
      width: 500px;
    }

    .card-preview {
      background: var(--bg-card);
      border: 2px solid var(--border-light);
      border-radius: 12px;
      overflow: hidden;
    }

    .card-image-area {
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 150px;
    }

    .card-image-area img {
      width: 100%;
      max-height: 300px;
      object-fit: contain;
    }

    .card-image-placeholder {
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    .card-content-area {
      padding: 1rem;
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }

    .card-body {
      font-size: 0.9375rem;
      color: var(--text-secondary);
      white-space: pre-wrap;
      line-height: 1.6;
      margin-bottom: 0.75rem;
    }

    .card-effects {
      font-style: italic;
      color: var(--warning);
      padding-top: 0.75rem;
      border-top: 1px solid var(--border-color);
    }

    .card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.375rem;
      margin-top: 0.75rem;
    }

    /* Global Search Modal */
    .search-modal {
      width: 600px;
      max-width: 95vw;
      max-height: 80vh;
    }

    .global-search-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 1rem;
      margin-bottom: 1rem;
    }

    .global-search-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .search-results {
      max-height: 400px;
      overflow-y: auto;
    }

    .search-result-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .search-result-item:hover {
      border-color: var(--accent);
      background: var(--bg-card);
    }

    .search-result-number {
      background: var(--accent);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      min-width: 28px;
      text-align: center;
    }

    .search-result-content {
      flex: 1;
      min-width: 0;
    }

    .search-result-title {
      font-weight: 600;
      font-size: 0.9375rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .search-result-context {
      font-size: 0.6875rem;
      color: var(--text-secondary);
      margin-top: 0.125rem;
      font-style: italic;
      opacity: 0.85;
    }

    .search-result-meta {
      font-size: 0.625rem;
      color: var(--text-muted);
      margin-top: 0.125rem;
    }

    .search-result-type {
      font-size: 0.625rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0.125rem 0.375rem;
      border-radius: 3px;
      font-weight: 600;
    }

    .search-result-type.card {
      background: var(--accent);
      color: white;
    }

    .search-result-type.text {
      background: var(--bg-card);
      color: var(--text-muted);
    }

    .search-result-image {
      color: var(--accent);
      font-size: 0.875rem;
    }

    .search-empty {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
    }

    .search-empty-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .search-hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
    }

    .search-result-count {
      font-size: 0.8125rem;
      color: var(--text-secondary);
      margin-bottom: 0.75rem;
    }

    /* Settings Modal */
    .settings-modal {
      width: 800px;
      max-width: 95vw;
    }

    .settings-tabs {
      display: flex;
      gap: 0.25rem;
      padding: 0 1rem;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
    }

    .settings-tab {
      padding: 0.75rem 1rem;
      border: none;
      background: none;
      color: var(--text-muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: all 0.15s ease;
    }

    .settings-tab:hover {
      color: var(--text-secondary);
    }

    .settings-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .settings-panel {
      display: none;
      padding: 1rem;
    }

    .settings-panel.active {
      display: block;
    }

    /* Forms */
    .form-group {
      margin-bottom: 1rem;
    }

    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.375rem;
      color: var(--text-secondary);
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 0.875rem;
      font-family: inherit;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-glow);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    /* Editor Lists */
    .editor-list {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 1rem;
    }

    .editor-list-header {
      background: var(--bg-tertiary);
      padding: 0.5rem 0.75rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border-color);
    }

    .editor-list-title {
      font-weight: 500;
      font-size: 0.875rem;
    }

    .editor-list-items {
      max-height: 300px;
      overflow-y: auto;
    }

    .editor-list-item {
      padding: 0.5rem 0.75rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border-color);
      transition: background 0.15s ease;
    }

    .editor-list-item:last-child {
      border-bottom: none;
    }

    .editor-list-item:hover {
      background: var(--bg-tertiary);
    }

    .editor-list-item.selected {
      background: var(--bg-card);
      border-left: 3px solid var(--accent);
    }

    .editor-list-item-name {
      flex: 1;
      cursor: pointer;
      padding: 0.25rem 0;
    }

    .editor-list-item-actions {
      display: flex;
      gap: 0.25rem;
    }

    .editor-empty {
      padding: 1.5rem;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    /* Entry Editor */
    .entry-type-toggle {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .entry-type-btn {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      background: var(--bg-tertiary);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .entry-type-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    .card-fields {
      display: none;
    }

    .card-fields.active {
      display: block;
    }

    .text-fields {
      display: none;
    }

    .text-fields.active {
      display: block;
    }

    /* Image Upload */
    .image-upload-area {
      border: 2px dashed var(--border-color);
      border-radius: 8px;
      padding: 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.15s ease;
      margin-bottom: 0.5rem;
    }

    .image-upload-area:hover {
      border-color: var(--accent);
      background: var(--bg-tertiary);
    }

    .image-upload-area.has-image {
      padding: 0.5rem;
    }

    .image-upload-area img {
      max-width: 100%;
      max-height: 200px;
      border-radius: 6px;
    }

    .image-upload-text {
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    /* Background Settings */
    .bg-preview {
      width: 100%;
      height: 150px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      margin-bottom: 0.75rem;
    }

    .bg-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .bg-preview-placeholder {
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    /* Toast */
    .toast-container {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 1100;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .toast {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      padding: 0.75rem 1rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px var(--shadow);
      animation: toastIn 0.3s ease;
      max-width: 300px;
    }

    .toast.success {
      border-color: var(--success);
    }

    .toast.error {
      border-color: var(--danger);
    }

    @keyframes toastIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Confirm Dialog */
    .confirm-modal {
      width: 400px;
    }

    .confirm-message {
      font-size: 1rem;
      margin-bottom: 1rem;
    }

    .input-modal {
      width: 350px;
    }

    .input-modal .form-input {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 0.875rem;
    }

    .input-modal .form-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Empty States */
    .empty-state {
      padding: 2rem 1rem;
      text-align: center;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
      opacity: 0.6;
    }

    .empty-state-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 0.375rem;
    }

    .empty-state-hint {
      font-size: 0.8125rem;
      color: var(--text-muted);
      margin-bottom: 1rem;
      line-height: 1.5;
    }

    .empty-state button {
      margin-top: 0.5rem;
    }

    /* Welcome/Help Modal */
    .welcome-modal {
      width: 520px;
    }

    .welcome-header {
      text-align: center;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 1.25rem;
    }

    .welcome-icon {
      font-size: 3rem;
      margin-bottom: 0.5rem;
    }

    .welcome-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }

    .welcome-subtitle {
      color: var(--text-secondary);
      font-size: 0.9375rem;
    }

    .welcome-steps {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .welcome-step {
      display: flex;
      gap: 1rem;
      align-items: flex-start;
    }

    .welcome-step-number {
      background: var(--accent);
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      flex-shrink: 0;
    }

    .welcome-step-content {
      flex: 1;
    }

    .welcome-step-title {
      font-weight: 600;
      margin-bottom: 0.125rem;
    }

    .welcome-step-desc {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .welcome-tips {
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .welcome-tips-title {
      font-weight: 600;
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.375rem;
    }

    .welcome-tips ul {
      margin: 0;
      padding-left: 1.25rem;
      font-size: 0.8125rem;
      color: var(--text-secondary);
    }

    .welcome-tips li {
      margin-bottom: 0.25rem;
    }

    .welcome-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .welcome-checkbox {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .welcome-checkbox input {
      width: 16px;
      height: 16px;
      accent-color: var(--accent);
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--border-light);
    }

    /* Utility */
    .hidden {
      display: none !important;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }

    /* Responsive styles for smaller screens */
    @media (max-width: 1100px) {
      .main-content {
        grid-template-columns: 150px 200px 1fr;
      }
      .column-header {
        padding: 0.5rem 0.6rem;
        font-size: 0.7rem;
      }
      .result-display {
        padding: 0.75rem;
      }
    }

    @media (max-width: 900px) {
      .main-content {
        grid-template-columns: 130px 170px 1fr;
      }
      .app-header h1 {
        font-size: 0.9rem;
      }
      .header-controls button {
        padding: 0.3rem 0.5rem;
        font-size: 0.7rem;
      }
      .roll-control button {
        padding: 0.4rem 0.6rem;
        font-size: 0.75rem;
      }
    }

    @media (max-width: 750px) {
      .main-content {
        grid-template-columns: 110px 140px 1fr;
        gap: 1px;
      }
      .step-badge {
        display: none;
      }
      .column-add-btn {
        width: 20px;
        height: 20px;
        font-size: 0.875rem;
      }
    }
  </style>
</head>
<body>
  <div id="app-background"></div>

  <div class="app-container">
    <header class="app-header">
      <h1 class="app-title">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
        </svg>
        <span id="app-title-text">Oakhart Roll Tables</span>
      </h1>
      <div class="header-actions">
        <button id="btn-global-search" aria-label="Search all entries" title="Search all entries (Ctrl+K)">üîç Search</button>
        <button id="btn-settings" aria-label="Open Settings">‚öôÔ∏è Settings</button>
        <button class="help-btn" id="btn-help" aria-label="Help" title="How to use this app">?</button>
      </div>
    </header>

    <!-- Selection Bar -->
    <div class="selection-bar" id="selection-bar">
      <span class="selection-bar-label">Current:</span>
      <span id="selection-display">No selection</span>
    </div>

    <main class="main-content">
      <!-- Categories Column -->
      <div class="column" id="categories-column">
        <div class="column-header">
          <span class="step-badge">1</span> Categories
          <button class="column-add-btn" id="btn-add-category-quick" title="Add category">+</button>
        </div>
        <div class="search-box">
          <input type="text" id="category-search" placeholder="Search..." aria-label="Search categories">
        </div>
        <div class="column-content" id="categories-list"></div>
      </div>

      <!-- Tables Column -->
      <div class="column" id="tables-column">
        <div class="column-header">
          <span class="step-badge waiting" id="step-2-badge">2</span> Tables
          <button class="column-add-btn" id="btn-add-table-quick" title="Add table">+</button>
        </div>
        <div class="search-box">
          <input type="text" id="table-search" placeholder="Search..." aria-label="Search tables">
        </div>
        <div class="column-content" id="tables-content">
          <div class="empty-state">
            <div class="empty-state-icon">üëà</div>
            <div class="empty-state-title">Select a Category</div>
            <div class="empty-state-hint">Choose a category from the left panel</div>
          </div>
        </div>
      </div>

      <!-- Results Column -->
      <div class="column results-column" id="results-column">
        <div class="column-header"><span class="step-badge waiting" id="step-3-badge">3</span> Results</div>
        <div class="current-result" id="current-result">
          <div class="empty-state">
            <div class="empty-state-icon">üé≤</div>
            <div class="empty-state-title">Ready to Roll!</div>
            <div class="empty-state-hint">Select a category and table, then click Roll</div>
          </div>
        </div>
        <div class="entries-header">
          <span class="entries-title">Entries</span>
          <button class="column-add-btn" id="btn-add-entry-quick" title="Add entry">+</button>
        </div>
        <div class="entries-list" id="entries-list">
          <div class="empty-state-small">Select a table to see entries</div>
        </div>
        <div class="dice-roller">
          <div class="dice-buttons" id="dice-buttons"></div>
          <div class="dice-result" id="dice-result">Click a die to roll</div>
        </div>
      </div>
    </main>
  </div>

  <!-- Card Modal -->
  <div class="modal-overlay" id="card-modal" role="dialog" aria-modal="true" aria-labelledby="card-modal-title">
    <div class="modal card-modal">
      <div class="modal-header">
        <h2 class="modal-title" id="card-modal-title">Card View</h2>
        <button class="modal-close" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="card-preview" id="card-preview">
          <div class="card-image-area" id="card-image-area">
            <span class="card-image-placeholder">No image</span>
          </div>
          <div class="card-content-area">
            <div class="card-title" id="card-title"></div>
            <div class="card-body" id="card-body"></div>
            <div class="card-effects" id="card-effects"></div>
            <div class="card-tags" id="card-tags"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btn-copy-text">Copy Text</button>
        <button id="btn-copy-image">Copy Image</button>
        <button id="btn-download-card">Download PNG</button>
        <button class="primary" id="btn-close-card">Close</button>
      </div>
    </div>
  </div>

  <!-- Global Search Modal -->
  <div class="modal-overlay" id="global-search-modal" role="dialog" aria-modal="true" aria-labelledby="search-modal-title">
    <div class="modal search-modal">
      <div class="modal-header">
        <h2 class="modal-title" id="search-modal-title">Search All Entries</h2>
        <button class="modal-close" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <input type="text" id="global-search-input" class="global-search-input" placeholder="Type to search entries..." autofocus>
        <div class="search-hint">Search by entry title, text, effects, or tags</div>
        <div id="search-results" class="search-results">
          <div class="search-empty">
            <div class="search-empty-icon">üîç</div>
            <div>Start typing to search across all tables</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settings-modal" role="dialog" aria-modal="true" aria-labelledby="settings-modal-title">
    <div class="modal settings-modal">
      <div class="modal-header">
        <h2 class="modal-title" id="settings-modal-title">Settings</h2>
        <button class="modal-close" aria-label="Close">&times;</button>
      </div>
      <div class="settings-tabs">
        <button class="settings-tab active" data-tab="categories">Categories</button>
        <button class="settings-tab" data-tab="tables">Tables</button>
        <button class="settings-tab" data-tab="entries">Entries</button>
        <button class="settings-tab" data-tab="appearance">Appearance</button>
        <button class="settings-tab" data-tab="data">Data</button>
      </div>
      <div class="modal-body" style="padding: 0; max-height: 60vh;">
        <!-- Categories Panel -->
        <div class="settings-panel active" id="panel-categories">
          <div class="editor-list">
            <div class="editor-list-header">
              <span class="editor-list-title">Categories</span>
              <button class="small primary" id="btn-add-category">+ Add</button>
            </div>
            <div class="editor-list-items" id="settings-categories-list"></div>
          </div>
          <div id="category-editor" class="hidden">
            <h3 style="margin-bottom: 1rem;">Edit Category</h3>
            <div class="form-group">
              <label class="form-label">Name</label>
              <input type="text" class="form-input" id="category-name-input" maxlength="50">
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button class="primary" id="btn-save-category">Save</button>
              <button id="btn-cancel-category">Cancel</button>
            </div>
          </div>
        </div>

        <!-- Tables Panel -->
        <div class="settings-panel" id="panel-tables">
          <div class="form-group">
            <label class="form-label">Category</label>
            <select class="form-select" id="settings-category-select"></select>
          </div>
          <div class="editor-list">
            <div class="editor-list-header">
              <span class="editor-list-title">Tables</span>
              <button class="small primary" id="btn-add-table">+ Add</button>
            </div>
            <div class="editor-list-items" id="settings-tables-list"></div>
          </div>
          <div id="table-editor" class="hidden">
            <h3 style="margin-bottom: 1rem;">Edit Table</h3>
            <div class="form-group">
              <label class="form-label">Name</label>
              <input type="text" class="form-input" id="table-name-input" maxlength="100">
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button class="primary" id="btn-save-table">Save</button>
              <button id="btn-cancel-table">Cancel</button>
            </div>
          </div>
        </div>

        <!-- Entries Panel -->
        <div class="settings-panel" id="panel-entries">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Category</label>
              <select class="form-select" id="entries-category-select"></select>
            </div>
            <div class="form-group">
              <label class="form-label">Table</label>
              <select class="form-select" id="entries-table-select"></select>
            </div>
          </div>
          <div class="editor-list">
            <div class="editor-list-header">
              <span class="editor-list-title">Entries <span id="entry-count">(0/100)</span></span>
              <button class="small primary" id="btn-add-entry">+ Add</button>
            </div>
            <div class="editor-list-items" id="settings-entries-list"></div>
          </div>
          <div id="entry-editor" class="hidden">
            <h3 style="margin-bottom: 1rem;">Edit Entry</h3>
            <div class="form-group">
              <label class="form-label">Title *</label>
              <input type="text" class="form-input" id="entry-title-input" maxlength="100" placeholder="Entry title...">
            </div>
            <div class="form-group">
              <label class="form-label">Description *</label>
              <textarea class="form-textarea" id="entry-body-input" placeholder="Entry description..."></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Image (optional)</label>
              <div class="image-upload-area" id="entry-image-upload">
                <span class="image-upload-text">Click or drag to upload image</span>
              </div>
              <input type="file" id="entry-image-file" accept="image/*" class="hidden">
              <button class="small" id="btn-clear-entry-image">Clear Image</button>
            </div>
            <div class="form-group">
              <label class="form-label">Effects (optional)</label>
              <input type="text" class="form-input" id="entry-effects-input" placeholder="Mechanical effects...">
            </div>
            <div class="form-group">
              <label class="form-label">Tags (optional, comma-separated)</label>
              <input type="text" class="form-input" id="entry-tags-input" placeholder="tag1, tag2, tag3">
            </div>
            <div class="form-group">
              <label class="form-label">Follow-up Tables (optional)</label>
              <select class="form-select" id="entry-followup-select" multiple style="height: 100px;"></select>
              <div class="form-hint">Hold Ctrl/Cmd to select multiple</div>
            </div>
            <button class="small" id="btn-preview-card" style="margin-bottom: 1rem;">Preview Card</button>
            <div style="display: flex; gap: 0.5rem;">
              <button class="primary" id="btn-save-entry">Save</button>
              <button id="btn-cancel-entry">Cancel</button>
            </div>
          </div>
        </div>

        <!-- Appearance Panel -->
        <div class="settings-panel" id="panel-appearance">
          <h3 style="margin-bottom: 1rem;">App Title</h3>
          <div class="form-group" style="margin-bottom: 1.5rem;">
            <label class="form-label">Title displayed in the header</label>
            <input type="text" class="form-input" id="app-title-input" placeholder="Oakhart Roll Tables" maxlength="50">
            <button class="primary small" id="btn-save-title" style="margin-top: 0.5rem;">Save Title</button>
          </div>

          <h3 style="margin-bottom: 1rem;">Theme</h3>
          <div class="form-group" style="margin-bottom: 1.5rem;">
            <label class="form-label">Color preset</label>
            <select class="form-select" id="theme-select">
              <option value="forest">Forest (Default)</option>
              <option value="ocean">Ocean</option>
              <option value="desert">Desert</option>
              <option value="winter">Winter</option>
              <option value="volcanic">Volcanic</option>
              <option value="amethyst">Amethyst</option>
            </select>
            <div class="theme-preview" id="theme-preview" style="margin-top: 0.75rem; padding: 1rem; border-radius: 6px; border: 1px solid var(--border-color);">
              <div style="display: flex; gap: 0.5rem; align-items: center;">
                <div class="theme-swatch" id="swatch-bg" style="width: 24px; height: 24px; border-radius: 4px; border: 1px solid var(--border-strong);"></div>
                <div class="theme-swatch" id="swatch-accent" style="width: 24px; height: 24px; border-radius: 4px; border: 1px solid var(--border-strong);"></div>
                <div class="theme-swatch" id="swatch-text" style="width: 24px; height: 24px; border-radius: 4px; border: 1px solid var(--border-strong);"></div>
                <span id="theme-name" style="color: var(--text-secondary); font-size: 0.875rem; margin-left: 0.5rem;">Forest</span>
              </div>
            </div>
            <button class="primary small" id="btn-apply-theme" style="margin-top: 0.75rem;">Apply Theme</button>
          </div>

          <h3 style="margin-bottom: 1rem;">Background Image</h3>
          <div class="bg-preview" id="bg-preview">
            <span class="bg-preview-placeholder">No background image set</span>
          </div>
          <div class="image-upload-area" id="bg-image-upload">
            <span class="image-upload-text">Click or drag to upload background image</span>
          </div>
          <input type="file" id="bg-image-file" accept="image/*" class="hidden">
          <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
            <button class="primary" id="btn-save-background">Save Background</button>
            <button id="btn-clear-background">Clear Background</button>
          </div>
        </div>

        <!-- Data Panel -->
        <div class="settings-panel" id="panel-data">
          <h3 style="margin-bottom: 1rem;">Import / Export</h3>
          <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.875rem;">
            Export your tables to share with other campaigns, or import table packs.
          </p>
          <div style="display: flex; gap: 0.5rem; margin-bottom: 2rem;">
            <button class="primary" id="btn-export-json">Export JSON</button>
            <button id="btn-import-json">Import JSON</button>
            <input type="file" id="import-file" accept=".json" class="hidden">
          </div>

          <h3 style="margin-bottom: 1rem;">Image Storage</h3>

          <!-- Desktop App Section -->
          <div id="electron-images-section" style="display: none; margin-bottom: 2rem;">
            <p style="color: var(--text-secondary); margin-bottom: 0.75rem; font-size: 0.875rem;">
              Images added to cards are saved in this folder on your computer:
            </p>
            <div id="images-folder-path" style="font-size: 0.85rem; color: var(--accent); background: var(--bg-tertiary); padding: 0.5rem 0.75rem; border-radius: 4px; margin-bottom: 1rem; word-break: break-all;">
              Loading...
            </div>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
              <button id="btn-open-images-folder" class="primary">Open Images Folder</button>
              <button id="btn-choose-images-folder">Change Location</button>
            </div>
            <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.75rem;">
              Changing the location will only affect new images. Existing images stay in the original folder.
            </p>
          </div>

          <!-- Browser Section (only shown when not running as desktop app) -->
          <div id="manual-path-section" style="margin-bottom: 2rem;">
            <p style="color: var(--text-secondary); margin-bottom: 0.75rem; font-size: 0.875rem;">
              When running in a browser, images are stored in the browser's memory and may be lost when cleared.
            </p>
            <p style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 0.75rem;">
              For a better experience, use the <strong>Oakhart DM Tools desktop app</strong> which saves images to a folder on your computer.
            </p>
            <div id="images-folder-status" style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.75rem; display: none;">
            </div>
            <!-- Hidden inputs for legacy support -->
            <input type="hidden" id="manual-image-path">
            <button id="btn-set-image-path" style="display: none;"></button>
          </div>

          <h3 style="margin-bottom: 1rem;">Reset Data</h3>
          <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.875rem;">
            Reset all tables to the default content. This cannot be undone.
          </p>
          <button class="danger" id="btn-reset-defaults">Reset to Defaults</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="primary" id="btn-close-settings">Close</button>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="modal-overlay" id="confirm-modal" role="dialog" aria-modal="true">
    <div class="modal confirm-modal">
      <div class="modal-header">
        <h2 class="modal-title" id="confirm-title">Confirm</h2>
        <button class="modal-close" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <p class="confirm-message" id="confirm-message"></p>
      </div>
      <div class="modal-footer">
        <button id="btn-confirm-cancel">Cancel</button>
        <button class="danger" id="btn-confirm-ok">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Input Modal -->
  <div class="modal-overlay" id="input-modal" role="dialog" aria-modal="true">
    <div class="modal input-modal">
      <div class="modal-header">
        <h2 class="modal-title" id="input-modal-title">Enter Name</h2>
        <button class="modal-close" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <input type="text" class="form-input" id="input-modal-value" placeholder="Enter name..." autofocus>
      </div>
      <div class="modal-footer">
        <button id="btn-input-cancel">Cancel</button>
        <button class="primary" id="btn-input-ok">Add</button>
      </div>
    </div>
  </div>

  <!-- Welcome/Help Modal -->
  <div class="modal-overlay" id="welcome-modal" role="dialog" aria-modal="true" aria-labelledby="welcome-modal-title">
    <div class="modal welcome-modal">
      <div class="modal-header">
        <h2 class="modal-title" id="welcome-modal-title">Welcome</h2>
        <button class="modal-close" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="welcome-header">
          <div class="welcome-icon">üé≤</div>
          <div class="welcome-title">Oakhart Roll Tables</div>
          <div class="welcome-subtitle">Your DM companion for random encounters, loot, NPCs, and more</div>
        </div>

        <div class="welcome-steps">
          <div class="welcome-step">
            <div class="welcome-step-number">1</div>
            <div class="welcome-step-content">
              <div class="welcome-step-title">Choose a Category</div>
              <div class="welcome-step-desc">Select from Loot, NPC, Encounter, Complication, or your own custom categories</div>
            </div>
          </div>
          <div class="welcome-step">
            <div class="welcome-step-number">2</div>
            <div class="welcome-step-content">
              <div class="welcome-step-title">Select a Table</div>
              <div class="welcome-step-desc">Pick a specific table within that category to roll on</div>
            </div>
          </div>
          <div class="welcome-step">
            <div class="welcome-step-number">3</div>
            <div class="welcome-step-content">
              <div class="welcome-step-title">Roll!</div>
              <div class="welcome-step-desc">Click the Roll button or enter a specific number to get your result</div>
            </div>
          </div>
        </div>

        <div class="welcome-tips">
          <div class="welcome-tips-title">üí° Tips</div>
          <ul>
            <li><strong>Edit tables:</strong> Click "Edit Table Entries" when viewing a table to add, remove, or modify entries</li>
            <li><strong>Card entries:</strong> Add images and detailed descriptions to create rich result cards</li>
            <li><strong>Quick dice:</strong> Use the dice roller at the bottom right for quick rolls</li>
            <li><strong>Settings:</strong> Create new categories, import/export tables, or set a custom background</li>
          </ul>
        </div>

        <div class="welcome-footer">
          <label class="welcome-checkbox">
            <input type="checkbox" id="dont-show-again">
            Don't show this again
          </label>
          <button class="primary" id="btn-welcome-start">Get Started</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <!-- Panel Backdrop -->
  <div class="panel-backdrop" id="panel-backdrop"></div>

  <!-- Table Editor Slide Panel -->
  <div class="table-editor-panel" id="table-editor-panel">
    <div class="table-editor-header">
      <div class="table-editor-title">
        <span id="editor-panel-title">Edit Table</span>
        <span class="entry-count-badge" id="editor-entry-count">0/100</span>
      </div>
      <button class="small" id="btn-close-editor-panel">‚úï Close</button>
    </div>
    <div class="table-editor-body">
      <!-- Add Entry Section -->
      <div class="add-entry-section">
        <button class="primary" id="btn-quick-add-entry" style="flex: 1;">+ Add Entry</button>
      </div>

      <!-- Inline Entry Editor (shown when editing/adding) -->
      <div class="inline-entry-editor hidden" id="inline-entry-editor">
        <div class="inline-editor-header">
          <span class="inline-editor-title" id="inline-editor-title">New Entry</span>
          <button class="small" id="btn-cancel-inline-edit">Cancel</button>
        </div>

        <div class="inline-form-group">
          <label class="inline-form-label">Title *</label>
          <input type="text" class="inline-form-input" id="inline-card-title" placeholder="Entry title...">
        </div>

        <div class="inline-form-group">
          <label class="inline-form-label">Description *</label>
          <textarea class="inline-form-textarea" id="inline-card-body" placeholder="Entry description..." rows="4"></textarea>
        </div>

        <div class="inline-form-group">
          <label class="inline-form-label">Image (optional)</label>
          <div class="inline-image-upload" id="inline-image-upload">
            <span class="inline-image-upload-text">Click to upload image</span>
          </div>
          <input type="file" id="inline-image-file" accept="image/*" class="hidden">
          <button class="small" id="btn-inline-clear-image" style="margin-top: 0.5rem;">Clear Image</button>
        </div>

        <div class="inline-form-row">
          <div class="inline-form-group">
            <label class="inline-form-label">Effects (optional)</label>
            <input type="text" class="inline-form-input" id="inline-card-effects" placeholder="Mechanical effects...">
          </div>
          <div class="inline-form-group">
            <label class="inline-form-label">Tags (optional)</label>
            <input type="text" class="inline-form-input" id="inline-card-tags" placeholder="tag1, tag2...">
          </div>
        </div>

        <div class="inline-form-group">
          <label class="inline-form-label">Follow-up Tables (optional)</label>
          <select class="inline-form-select" id="inline-card-followup" multiple style="height: 70px;"></select>
        </div>

        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
          <button class="small" id="btn-inline-preview-card">Preview Card</button>
        </div>

        <div class="inline-editor-actions">
          <button class="primary" id="btn-save-inline-entry" style="flex: 1;">Save Entry</button>
          <button class="danger" id="btn-delete-inline-entry">Delete</button>
        </div>
      </div>

      <!-- Entry List -->
      <div class="quick-entry-list" id="quick-entry-list"></div>
    </div>
    <div class="table-editor-footer">
      <button class="primary" id="btn-done-editing" style="flex: 1;">Done Editing</button>
    </div>
  </div>

  <script>
    // ============================================
    // DATA MODEL & STORAGE
    // ============================================
    const STORAGE_KEY = 'oakhartRollTables.v1';
    const SETTINGS_STORAGE_KEY = 'oakhartRollTables.settings';
    const DATA_VERSION = 1;

    // Theme presets
    const THEME_PRESETS = {
      forest: {
        name: 'Forest',
        vars: {
          '--bg-primary': '#111816',
          '--bg-secondary': '#161f1b',
          '--bg-tertiary': '#1c2723',
          '--bg-card': '#212d28',
          '--border-color': '#2a3832',
          '--border-strong': '#3a4a42',
          '--text-primary': '#e4ebe4',
          '--text-secondary': '#9aaa9a',
          '--text-muted': '#5a6a5a',
          '--accent': '#4a7c59',
          '--accent-hover': '#5a9469',
          '--accent-glow': 'rgba(74, 124, 89, 0.25)',
          '--danger': '#8b3a3a',
          '--danger-hover': '#a04545',
          '--warning': '#8b7355',
          '--success': '#4a7c59'
        }
      },
      ocean: {
        name: 'Ocean',
        vars: {
          '--bg-primary': '#0a1520',
          '--bg-secondary': '#0f1c28',
          '--bg-tertiary': '#142430',
          '--bg-card': '#1a2d3a',
          '--border-color': '#2a4050',
          '--border-strong': '#3a5565',
          '--text-primary': '#e4eef5',
          '--text-secondary': '#8ab0c8',
          '--text-muted': '#5a7a90',
          '--accent': '#3a8cb5',
          '--accent-hover': '#4a9cc8',
          '--accent-glow': 'rgba(58, 140, 181, 0.25)',
          '--danger': '#8b4a4a',
          '--danger-hover': '#a05555',
          '--warning': '#8b8055',
          '--success': '#3a8c7c'
        }
      },
      desert: {
        name: 'Desert',
        vars: {
          '--bg-primary': '#1a1510',
          '--bg-secondary': '#221c15',
          '--bg-tertiary': '#2a241c',
          '--bg-card': '#352d22',
          '--border-color': '#4a4030',
          '--border-strong': '#5a5040',
          '--text-primary': '#f0e8dc',
          '--text-secondary': '#c8b898',
          '--text-muted': '#8a7860',
          '--accent': '#c89040',
          '--accent-hover': '#d8a050',
          '--accent-glow': 'rgba(200, 144, 64, 0.25)',
          '--danger': '#a04040',
          '--danger-hover': '#b05050',
          '--warning': '#c89040',
          '--success': '#6a9050'
        }
      },
      winter: {
        name: 'Winter',
        vars: {
          '--bg-primary': '#0c1015',
          '--bg-secondary': '#10151c',
          '--bg-tertiary': '#151c25',
          '--bg-card': '#1c2530',
          '--border-color': '#2a3545',
          '--border-strong': '#3a4a5a',
          '--text-primary': '#e8f0f8',
          '--text-secondary': '#a0b8d0',
          '--text-muted': '#6080a0',
          '--accent': '#5090c0',
          '--accent-hover': '#60a0d0',
          '--accent-glow': 'rgba(80, 144, 192, 0.25)',
          '--danger': '#904050',
          '--danger-hover': '#a05060',
          '--warning': '#a08050',
          '--success': '#408080'
        }
      },
      volcanic: {
        name: 'Volcanic',
        vars: {
          '--bg-primary': '#181010',
          '--bg-secondary': '#201515',
          '--bg-tertiary': '#281c1c',
          '--bg-card': '#322222',
          '--border-color': '#4a3030',
          '--border-strong': '#5a4040',
          '--text-primary': '#f5e8e4',
          '--text-secondary': '#c8a098',
          '--text-muted': '#8a6860',
          '--accent': '#c85040',
          '--accent-hover': '#d86050',
          '--accent-glow': 'rgba(200, 80, 64, 0.25)',
          '--danger': '#c84040',
          '--danger-hover': '#d85050',
          '--warning': '#c88040',
          '--success': '#609050'
        }
      },
      amethyst: {
        name: 'Amethyst',
        vars: {
          '--bg-primary': '#14101a',
          '--bg-secondary': '#1a1522',
          '--bg-tertiary': '#221c2c',
          '--bg-card': '#2a2438',
          '--border-color': '#3a3050',
          '--border-strong': '#4a4065',
          '--text-primary': '#f0e8f5',
          '--text-secondary': '#b8a0c8',
          '--text-muted': '#7a6090',
          '--accent': '#8050a0',
          '--accent-hover': '#9060b0',
          '--accent-glow': 'rgba(128, 80, 160, 0.25)',
          '--danger': '#a04060',
          '--danger-hover': '#b05070',
          '--warning': '#a08050',
          '--success': '#508070'
        }
      }
    };

    const defaultData = {
      version: DATA_VERSION,
      backgroundImage: null,
      categories: [
        {
          id: 'loot',
          name: 'Loot',
          tables: [
            {
              id: 'loot-pockets',
              name: 'Pockets of the Dead',
              entries: [
                { type: 'text', text: 'A handful of corroded copper pennies, dated before the war.' },
                { type: 'text', text: 'A crumpled letter, ink long faded, smelling of lavender and rot.' },
                { type: 'text', text: 'Three teeth tied together with black thread.' },
                { type: 'text', text: 'A tarnished locket containing a lock of gray hair.' },
                { type: 'text', text: 'A carved bone whistle that makes no sound when blown.' },
                { type: 'text', text: 'A small jar of honey, still perfectly preserved.' },
                { type: 'text', text: 'A rabbit\'s foot, far too large to be from any ordinary rabbit.' },
                { type: 'text', text: 'A hand-drawn map to a place that doesn\'t exist anymore.' },
                { type: 'text', text: 'Seven iron nails wrapped in oilcloth.' },
                { type: 'text', text: 'A pocket watch stopped at 3:33.' }
              ]
            },
            {
              id: 'loot-abandoned',
              name: 'Abandoned Homestead Finds',
              entries: [
                { type: 'text', text: 'A quilt sewn with patterns that hurt to look at too long.' },
                { type: 'text', text: 'Mason jars filled with murky preserves‚Äîsomething moves inside one.' },
                { type: 'text', text: 'A family Bible with entire generations crossed out in red ink.' },
                { type: 'text', text: 'A rocking chair that creaks even when empty.' },
                { type: 'text', text: 'Bundles of dried herbs hanging from the rafters, some unidentifiable.' },
                { type: 'text', text: 'A shotgun with one shell remaining, rusted shut.' },
                { type: 'text', text: 'A child\'s doll made of corn husks, dressed in mourning clothes.' },
                { type: 'text', text: 'An iron cookstove still warm to the touch.' },
                { type: 'text', text: 'A stack of yellowed newspapers reporting events yet to happen.' },
                { type: 'text', text: 'A moonshine still, operational, tended by no one.' }
              ]
            }
          ]
        },
        {
          id: 'npc',
          name: 'NPC',
          tables: [
            {
              id: 'npc-strangers',
              name: 'Strangers on the Road',
              entries: [
                { type: 'text', text: 'A traveling preacher whose shadow moves independently of his body.' },
                { type: 'text', text: 'An old woman selling apples from a cart that leaves no wheel tracks.' },
                { type: 'text', text: 'A census taker asking questions about people who died decades ago.' },
                { type: 'text', text: 'A child walking alone, humming a tune no one taught them.' },
                { type: 'text', text: 'A mail carrier delivering letters to abandoned houses.' },
                { type: 'text', text: 'Twin sisters who finish each other\'s sentences before they\'re spoken.' },
                { type: 'text', text: 'A fiddler whose music makes the trees lean closer.' },
                { type: 'text', text: 'A mute beggar whose eyes reflect places you\'ve never been.' },
                { type: 'text', text: 'A tax collector for a county that no longer exists.' },
                { type: 'text', text: 'A woman in a wedding dress, walking toward something only she can see.' }
              ]
            },
            {
              id: 'npc-townsfolk',
              name: 'Hollow Ridge Townsfolk',
              entries: [
                { type: 'text', text: 'The shopkeeper who weighs everything twice and trusts nothing.' },
                { type: 'text', text: 'The blacksmith whose forge burns cold and blue at midnight.' },
                { type: 'text', text: 'The schoolmarm teaching lessons from books written in no known language.' },
                { type: 'text', text: 'The barber who knows everyone\'s secrets and pretends otherwise.' },
                { type: 'text', text: 'The undertaker who measures the living with a knowing eye.' },
                { type: 'text', text: 'The midwife who has never lost a mother, though some wish she had.' },
                { type: 'text', text: 'The drunk who speaks prophecy between blackouts.' },
                { type: 'text', text: 'The church organist who only plays songs for the dead.' },
                { type: 'text', text: 'The general store clerk who remembers purchases you haven\'t made yet.' },
                { type: 'text', text: 'The mayor, elected unanimously, though no one recalls the vote.' }
              ]
            }
          ]
        },
        {
          id: 'encounter',
          name: 'Encounter',
          tables: [
            {
              id: 'encounter-woods',
              name: 'Deep Woods Encounters',
              entries: [
                { type: 'text', text: 'A clearing where all the trees have grown facing away from the center.' },
                { type: 'text', text: 'The sound of chopping, but no woodsman to be found.' },
                { type: 'text', text: 'A perfectly stacked cairn of stones that wasn\'t there a moment ago.' },
                { type: 'text', text: 'Animal bones arranged in geometric patterns along the trail.' },
                { type: 'text', text: 'A spring whose water tastes of copper and regret.' },
                { type: 'text', text: 'Bootprints in the mud that end abruptly mid-stride.' },
                { type: 'text', text: 'A hunting blind built high in the trees, watching the trail below.' },
                { type: 'text', text: 'The smell of woodsmoke but no fire visible for miles.' },
                { type: 'text', text: 'A tree scarred with claw marks far too high for any bear.' },
                { type: 'text', text: 'A child\'s laughter echoing from all directions at once.' }
              ]
            },
            {
              id: 'encounter-night',
              name: 'Things After Dark',
              entries: [
                { type: 'text', text: 'Lights bobbing through the hollow that aren\'t lanterns or fireflies.' },
                { type: 'text', text: 'The sensation of being watched from just beyond the firelight.' },
                { type: 'text', text: 'A knock at the door, though you\'re miles from any dwelling.' },
                { type: 'text', text: 'Your campfire dims as something large passes overhead.' },
                { type: 'text', text: 'Whispers in a language you almost understand.' },
                { type: 'text', text: 'The sound of a congregation singing hymns from an empty church.' },
                { type: 'text', text: 'A figure at the crossroads, standing perfectly still.' },
                { type: 'text', text: 'Your reflection in the water doesn\'t match your movements.' },
                { type: 'text', text: 'The moon seems wrong tonight‚Äîtoo large, too close, too hungry.' },
                { type: 'text', text: 'Hoofbeats approaching, but the road remains empty.' }
              ]
            }
          ]
        },
        {
          id: 'complication',
          name: 'Complication',
          tables: [
            {
              id: 'complication-social',
              name: 'Social Complications',
              entries: [
                { type: 'text', text: 'Someone recognizes you from a place you\'ve never been.' },
                { type: 'text', text: 'An old debt comes due‚Äîone you don\'t remember incurring.' },
                { type: 'text', text: 'The locals go silent the moment they see your face.' },
                { type: 'text', text: 'A child delivers a message meant for someone else, but it\'s in your handwriting.' },
                { type: 'text', text: 'You\'ve been expected. A room was already prepared.' },
                { type: 'text', text: 'Someone you trust has been spreading lies about your intentions.' },
                { type: 'text', text: 'The town holds a grudge against your family going back generations.' },
                { type: 'text', text: 'A rival arrives, claiming you\'ve stolen something precious.' },
                { type: 'text', text: 'You\'re offered hospitality that feels more like imprisonment.' },
                { type: 'text', text: 'The person you came to meet died last night‚Äîbut sent a letter this morning.' }
              ]
            },
            {
              id: 'complication-environment',
              name: 'Environmental Complications',
              entries: [
                { type: 'text', text: 'The bridge you crossed yesterday is gone, as if it never existed.' },
                { type: 'text', text: 'A fog rolls in that your compass cannot navigate.' },
                { type: 'text', text: 'The road loops back on itself no matter which direction you travel.' },
                { type: 'text', text: 'A sudden storm forces shelter in a place best avoided.' },
                { type: 'text', text: 'The local well has gone dry‚Äîor worse, changed color.' },
                { type: 'text', text: 'Landslide blocks the only pass; the long way adds three days.' },
                { type: 'text', text: 'Something has spooked all the animals for miles around.' },
                { type: 'text', text: 'The temperature drops unnaturally as you approach your destination.' },
                { type: 'text', text: 'Your supplies have spoiled overnight, though they were fresh at dusk.' },
                { type: 'text', text: 'The map shows a town here. There is only a foundation and graves.' }
              ]
            }
          ]
        }
      ]
    };

    // State
    let appData = null;
    let selectedCategoryId = null;
    let selectedTableId = null;
    let rollHistory = [];
    let currentCardData = null;
    const WELCOME_DISMISSED_KEY = 'oakhartWelcomeDismissed';

    // Editor state
    let editingCategoryId = null;
    let editingTableId = null;
    let editingEntryIndex = null;
    let entryImageData = null;
    let pendingBackgroundImage = null;

    // Inline editor state
    let inlineEditorCategoryId = null;
    let inlineEditorTableId = null;
    let inlineEditingIndex = null;
    let inlineImageData = null;

    // Confirm callback
    let confirmCallback = null;

    // ============================================
    // STORAGE FUNCTIONS
    // ============================================
    function loadData() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          const parsed = JSON.parse(stored);
          if (parsed.version === DATA_VERSION) {
            appData = parsed;
          } else {
            // Migration stub for future versions
            appData = migrateData(parsed);
          }
        } else {
          appData = JSON.parse(JSON.stringify(defaultData));
        }
      } catch (e) {
        console.error('Failed to load data:', e);
        appData = JSON.parse(JSON.stringify(defaultData));
      }
    }

    function saveData() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
      } catch (e) {
        console.error('Failed to save data:', e);
        showToast('Failed to save data', 'error');
      }
    }

    function migrateData(oldData) {
      // Future migration logic here
      return JSON.parse(JSON.stringify(defaultData));
    }

    function resetToDefaults() {
      appData = JSON.parse(JSON.stringify(defaultData));
      saveData();
      selectedCategoryId = null;
      selectedTableId = null;
      renderAll();
      showToast('Data reset to defaults', 'success');
    }

    // ============================================
    // THEME & SETTINGS
    // ============================================
    function loadAppSettings() {
      try {
        const stored = localStorage.getItem(SETTINGS_STORAGE_KEY);
        if (stored) {
          return JSON.parse(stored);
        }
      } catch (e) {
        console.error('Failed to load app settings:', e);
      }
      return { theme: 'forest', title: 'Oakhart Roll Tables' };
    }

    function saveAppSettings(settings) {
      try {
        localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(settings));
      } catch (e) {
        console.error('Failed to save app settings:', e);
      }
    }

    function applyTheme(themeId) {
      const theme = THEME_PRESETS[themeId] || THEME_PRESETS.forest;
      const root = document.documentElement;

      // Apply all CSS variables
      for (const [key, value] of Object.entries(theme.vars)) {
        root.style.setProperty(key, value);
      }

      // Update settings
      const settings = loadAppSettings();
      settings.theme = themeId;
      saveAppSettings(settings);

      // Update the select dropdown
      const select = document.getElementById('theme-select');
      if (select) {
        select.value = themeId;
      }

      // Update preview
      updateThemePreview(themeId);
    }

    function updateThemePreview(themeId) {
      const theme = THEME_PRESETS[themeId] || THEME_PRESETS.forest;

      const swatchBg = document.getElementById('swatch-bg');
      const swatchAccent = document.getElementById('swatch-accent');
      const swatchText = document.getElementById('swatch-text');
      const themeName = document.getElementById('theme-name');

      if (swatchBg) swatchBg.style.backgroundColor = theme.vars['--bg-primary'];
      if (swatchAccent) swatchAccent.style.backgroundColor = theme.vars['--accent'];
      if (swatchText) swatchText.style.backgroundColor = theme.vars['--text-primary'];
      if (themeName) themeName.textContent = theme.name;
    }

    function applyTitle(title) {
      const titleEl = document.getElementById('app-title-text');
      if (titleEl) {
        titleEl.textContent = title || 'Oakhart Roll Tables';
      }

      // Also update the document title
      document.title = title || 'Oakhart Roll Tables';

      // Save to settings
      const settings = loadAppSettings();
      settings.title = title || 'Oakhart Roll Tables';
      saveAppSettings(settings);
    }

    function initAppSettings() {
      const settings = loadAppSettings();

      // Apply saved theme
      applyTheme(settings.theme || 'forest');

      // Apply saved title
      const titleEl = document.getElementById('app-title-text');
      if (titleEl && settings.title) {
        titleEl.textContent = settings.title;
        document.title = settings.title;
      }

      // Update input field
      const titleInput = document.getElementById('app-title-input');
      if (titleInput) {
        titleInput.value = settings.title || 'Oakhart Roll Tables';
      }
    }

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    function generateId() {
      return 'id-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function rollDice(sides) {
      return Math.floor(Math.random() * sides) + 1;
    }

    function getDiceNotation(count) {
      if (count === 100) return 'd100';
      if (count === 20) return 'd20';
      if (count === 12) return 'd12';
      if (count === 10) return 'd10';
      if (count === 8) return 'd8';
      if (count === 6) return 'd6';
      if (count === 4) return 'd4';
      return 'd' + count;
    }

    function formatTime(date) {
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast ' + type;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function showConfirm(title, message, callback) {
      document.getElementById('confirm-title').textContent = title;
      document.getElementById('confirm-message').textContent = message;
      confirmCallback = callback;
      document.getElementById('confirm-modal').classList.add('active');
    }

    function closeConfirm() {
      document.getElementById('confirm-modal').classList.remove('active');
      confirmCallback = null;
    }

    let inputCallback = null;

    function showInputModal(title, placeholder, callback) {
      document.getElementById('input-modal-title').textContent = title;
      const input = document.getElementById('input-modal-value');
      input.value = '';
      input.placeholder = placeholder || 'Enter name...';
      inputCallback = callback;
      document.getElementById('input-modal').classList.add('active');
      setTimeout(() => input.focus(), 100);
    }

    function closeInputModal() {
      document.getElementById('input-modal').classList.remove('active');
      inputCallback = null;
    }

    function submitInputModal() {
      const value = document.getElementById('input-modal-value').value.trim();
      if (!value) {
        showToast('Please enter a name', 'error');
        return;
      }
      if (inputCallback) {
        inputCallback(value);
      }
      closeInputModal();
    }

    function fileToDataUrl(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // ============================================
    // FILE SYSTEM ACCESS API (for saving images to folder)
    // ============================================
    let imagesFolderHandle = null;
    const IMAGES_FOLDER_NAME = 'images';

    function isFileSystemAccessSupported() {
      return 'showDirectoryPicker' in window;
    }

    async function selectImagesFolder() {
      if (!isFileSystemAccessSupported()) {
        showToast('Your browser does not support folder access. Use the manual path option below.', 'error');
        return false;
      }

      // Check if running from file:// protocol
      if (window.location.protocol === 'file:') {
        showToast('Folder picker requires a web server. Use the manual path option below.', 'error');
        return false;
      }

      try {
        imagesFolderHandle = await window.showDirectoryPicker({
          mode: 'readwrite',
          startIn: 'documents'
        });
        showToast(`Images folder set: ${imagesFolderHandle.name}`, 'success');
        updateImagesFolderStatus();
        return true;
      } catch (err) {
        console.error('Folder selection error:', err);
        if (err.name !== 'AbortError') {
          showToast(`Failed to select folder: ${err.message}`, 'error');
        }
        return false;
      }
    }

    // Manual image path prefix for file:// usage
    let manualImagePath = localStorage.getItem('oakhartImagePath') || '';

    function setManualImagePath(path) {
      manualImagePath = path.trim();
      if (manualImagePath && !manualImagePath.endsWith('/')) {
        manualImagePath += '/';
      }
      localStorage.setItem('oakhartImagePath', manualImagePath);
      updateImagesFolderStatus();
      showToast(manualImagePath ? `Image path set: ${manualImagePath}` : 'Image path cleared', 'success');
    }

    function downloadImageFile(file, filename) {
      const url = URL.createObjectURL(file);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    async function processImageUpload(file) {
      if (!file || !file.type.startsWith('image/')) {
        showToast('Please select an image file', 'error');
        return null;
      }

      const ext = file.name.split('.').pop() || 'png';
      const timestamp = Date.now();
      const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_').replace(/\.[^.]+$/, '');
      const filename = `${safeName}-${timestamp}.${ext}`;

      // If running in Electron, use native file saving
      if (window.electronAPI) {
        try {
          const dataUrl = await fileToDataUrl(file);
          const result = await window.electronAPI.saveImage(filename, dataUrl);
          if (result.success) {
            showToast(`Image saved: ${filename}`, 'success');
            return result.path;
          }
        } catch (e) {
          console.error('Electron save failed:', e);
        }
        // Fall through to base64 if Electron save fails
      }

      // If manual path is set (browser mode), download the file and return the path
      if (manualImagePath) {
        const fullPath = `${manualImagePath}${filename}`;

        // Download the file for the user to save
        downloadImageFile(file, filename);
        showToast(`Save the downloaded image to your "${manualImagePath}" folder`, 'success');

        return fullPath;
      }

      // If folder handle exists (web server context), save directly
      if (imagesFolderHandle) {
        const savedPath = await saveImageToFolder(file);
        if (savedPath) return savedPath;
      }

      // Fallback to base64
      return await fileToDataUrl(file);
    }

    async function saveImageToFolder(file) {
      if (!imagesFolderHandle) {
        return null; // No folder selected, fall back to base64
      }

      try {
        // Verify we still have permission
        const permission = await imagesFolderHandle.queryPermission({ mode: 'readwrite' });
        if (permission !== 'granted') {
          const request = await imagesFolderHandle.requestPermission({ mode: 'readwrite' });
          if (request !== 'granted') {
            showToast('Folder permission denied. Using base64.', 'error');
            return null;
          }
        }

        // Generate unique filename
        const ext = file.name.split('.').pop() || 'png';
        const timestamp = Date.now();
        const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_').replace(/\.[^.]+$/, '');
        const filename = `${safeName}-${timestamp}.${ext}`;

        // Write file to folder
        const fileHandle = await imagesFolderHandle.getFileHandle(filename, { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(file);
        await writable.close();

        // Return relative path
        const relativePath = `${imagesFolderHandle.name}/${filename}`;
        showToast(`Image saved: ${filename}`, 'success');
        return relativePath;
      } catch (err) {
        console.error('Failed to save image:', err);
        showToast('Failed to save image to folder. Using base64.', 'error');
        return null;
      }
    }

    async function updateImagesFolderStatus() {
      const electronSection = document.getElementById('electron-images-section');
      const browserSection = document.getElementById('manual-path-section');
      const pathDisplay = document.getElementById('images-folder-path');
      const statusEl = document.getElementById('images-folder-status');
      const pathInput = document.getElementById('manual-image-path');

      // Check if running in Electron
      if (window.electronAPI) {
        // Show Electron UI, hide browser UI
        if (electronSection) electronSection.style.display = 'block';
        if (browserSection) browserSection.style.display = 'none';

        // Get and display current images path
        try {
          const info = await window.electronAPI.getAppInfo();
          if (pathDisplay && info.imagesPath) {
            pathDisplay.textContent = info.imagesPath;
          }
        } catch (e) {
          if (pathDisplay) pathDisplay.textContent = 'Unable to get path';
        }
      } else {
        // Browser mode - show browser UI, hide Electron UI
        if (electronSection) electronSection.style.display = 'none';
        if (browserSection) browserSection.style.display = 'block';

        if (pathInput && manualImagePath) {
          pathInput.value = manualImagePath.replace(/\/$/, '');
        }

        if (statusEl) {
          if (imagesFolderHandle) {
            statusEl.textContent = `Folder connected: ${imagesFolderHandle.name} (auto-save enabled)`;
            statusEl.classList.add('active');
          } else if (manualImagePath) {
            statusEl.textContent = `Path set: ${manualImagePath} (images will download for you to save)`;
            statusEl.classList.add('active');
          } else {
            statusEl.textContent = 'No folder configured (images stored as base64 in browser)';
            statusEl.classList.remove('active');
          }
        }
      }
    }

    // ============================================
    // DATA HELPERS
    // ============================================
    function getCategory(id) {
      return appData.categories.find(c => c.id === id);
    }

    function getTable(categoryId, tableId) {
      const cat = getCategory(categoryId);
      return cat ? cat.tables.find(t => t.id === tableId) : null;
    }

    function findTableById(tableId) {
      for (const cat of appData.categories) {
        const table = cat.tables.find(t => t.id === tableId);
        if (table) return { category: cat, table };
      }
      return null;
    }

    function getAllTables() {
      const tables = [];
      for (const cat of appData.categories) {
        for (const table of cat.tables) {
          tables.push({ categoryId: cat.id, categoryName: cat.name, ...table });
        }
      }
      return tables;
    }

    // ============================================
    // RENDER FUNCTIONS
    // ============================================
    function renderAll() {
      renderBackground();
      renderCategories();
      renderTables();
      renderCurrentResult();
      renderEntries();
      renderDiceButtons();
    }

    function renderBackground() {
      const bg = document.getElementById('app-background');
      if (appData.backgroundImage) {
        bg.style.backgroundImage = `url(${appData.backgroundImage})`;
      } else {
        bg.style.backgroundImage = 'none';
      }
    }

    function renderCategories() {
      const list = document.getElementById('categories-list');
      const searchInput = document.getElementById('category-search');
      const searchTerm = searchInput.value.toLowerCase().trim();

      list.innerHTML = '';

      let categories = appData.categories;
      if (searchTerm) {
        categories = categories.filter(c =>
          c.name.toLowerCase().includes(searchTerm) ||
          c.tables.some(t => t.name.toLowerCase().includes(searchTerm))
        );
      }

      if (categories.length === 0) {
        if (searchTerm) {
          list.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üîç</div>
              <div class="empty-state-title">No Results</div>
              <div class="empty-state-hint">No categories match "${escapeHtml(searchTerm)}"</div>
              <button class="small" onclick="document.getElementById('category-search').value=''; renderCategories();">Clear Search</button>
            </div>
          `;
        } else {
          list.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üìÅ</div>
              <div class="empty-state-title">No Categories</div>
              <div class="empty-state-hint">Create your first category in Settings</div>
              <button class="small primary" onclick="openSettings(); switchSettingsTab('categories');">+ Add Category</button>
            </div>
          `;
        }
        return;
      }

      for (const cat of categories) {
        const item = document.createElement('div');
        item.className = 'list-item' + (cat.id === selectedCategoryId ? ' selected' : '');
        item.title = `Click to view tables in ${cat.name}`;
        item.innerHTML = `
          <div class="list-item-title">${escapeHtml(cat.name)}</div>
          <div class="list-item-meta">${cat.tables.length} table${cat.tables.length !== 1 ? 's' : ''}</div>
        `;
        item.addEventListener('click', () => selectCategory(cat.id));
        list.appendChild(item);
      }
    }

    function renderTables() {
      const content = document.getElementById('tables-content');
      const searchInput = document.getElementById('table-search');
      const searchTerm = searchInput.value.toLowerCase().trim();

      if (!selectedCategoryId) {
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üëà</div>
            <div class="empty-state-title">Select a Category</div>
            <div class="empty-state-hint">Choose a category from the left panel to see available tables</div>
          </div>
        `;
        return;
      }

      const category = getCategory(selectedCategoryId);
      if (!category) return;

      let tables = category.tables;
      if (searchTerm) {
        tables = tables.filter(t => t.name.toLowerCase().includes(searchTerm));
      }

      if (tables.length === 0) {
        if (searchTerm) {
          content.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üîç</div>
              <div class="empty-state-title">No Results</div>
              <div class="empty-state-hint">No tables match "${escapeHtml(searchTerm)}"</div>
              <button class="small" onclick="document.getElementById('table-search').value=''; renderTables();">Clear Search</button>
            </div>
          `;
        } else {
          content.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üì≠</div>
              <div class="empty-state-title">No Tables Yet</div>
              <div class="empty-state-hint">This category is empty. Add tables in Settings or click below.</div>
              <button class="small primary" onclick="openSettings(); switchSettingsTab('tables');">+ Add Table</button>
            </div>
          `;
        }
        return;
      }

      content.innerHTML = '';

      // Selected table info and controls
      if (selectedTableId) {
        const table = tables.find(t => t.id === selectedTableId);
        if (table) {
          const tableInfo = document.createElement('div');
          tableInfo.innerHTML = `
            <div class="table-info">
              <div class="table-info-name">${escapeHtml(table.name)}</div>
              <div class="table-info-dice">${table.entries.length} entries ‚Ä¢ ${getDiceNotation(table.entries.length)}</div>
            </div>
            <div class="roll-controls">
              <button class="roll-btn primary" id="btn-roll">Roll ${getDiceNotation(table.entries.length)}</button>
            </div>
            <div class="manual-roll">
              <input type="number" id="manual-roll-input" min="1" max="${table.entries.length}" placeholder="1-${table.entries.length}">
              <button id="btn-use-roll">Use</button>
            </div>
            <button class="edit-table-btn" id="btn-edit-table" style="width: 100%;" title="Add, edit, or remove entries from this table">‚úèÔ∏è Edit Table Entries</button>
          `;
          content.appendChild(tableInfo);

          document.getElementById('btn-roll').addEventListener('click', () => rollOnTable());
          document.getElementById('btn-use-roll').addEventListener('click', () => useManualRoll());
          document.getElementById('manual-roll-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') useManualRoll();
          });
          document.getElementById('btn-edit-table').addEventListener('click', () => openTableEditorPanel());
        }
      }

      // Table list
      for (const table of tables) {
        const item = document.createElement('div');
        item.className = 'list-item' + (table.id === selectedTableId ? ' selected' : '');
        item.title = `Click to select "${table.name}" for rolling`;
        item.innerHTML = `
          <div class="list-item-title">${escapeHtml(table.name)}</div>
          <div class="list-item-meta">${table.entries.length} entries ‚Ä¢ ${getDiceNotation(table.entries.length)}</div>
        `;
        item.addEventListener('click', () => selectTable(table.id));
        content.appendChild(item);
      }
    }

    function renderCurrentResult() {
      const container = document.getElementById('current-result');

      if (rollHistory.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üé≤</div>
            <div>Select a table and roll</div>
          </div>
        `;
        return;
      }

      const latest = rollHistory[0];
      const entry = latest.entry;
      const isCard = entry.type === 'card';
      const hasImage = isCard && entry.image;

      let html = `<div class="result-card${hasImage ? ' has-image' : ''}" ${hasImage ? 'id="result-card-clickable"' : ''}>`;
      html += `<span class="result-roll-number">#${latest.rollNumber}</span>`;

      if (hasImage) {
        html += `<img src="${entry.image}" class="result-image-preview" alt="">`;
      }

      if (isCard) {
        html += `<div class="result-title">${escapeHtml(entry.title || 'Untitled')}</div>`;
        html += `<div class="result-body">${escapeHtml(entry.body || '')}</div>`;
        if (entry.effects) {
          html += `<div class="result-effects">Effects: ${escapeHtml(entry.effects)}</div>`;
        }
        if (entry.tags && entry.tags.length > 0) {
          html += `<div class="result-tags">${entry.tags.map(t => `<span class="tag">${escapeHtml(t)}</span>`).join('')}</div>`;
        }
      } else {
        html += `<div class="result-body">${escapeHtml(entry.text || '')}</div>`;
      }

      // Follow-up tables
      if (isCard && entry.followUpTables && entry.followUpTables.length > 0) {
        html += `<div class="follow-up-tables">`;
        html += `<div class="follow-up-label">Suggested follow-ups:</div>`;
        html += `<div class="follow-up-chips">`;
        for (const tableId of entry.followUpTables) {
          const found = findTableById(tableId);
          if (found) {
            html += `<span class="follow-up-chip" data-table-id="${tableId}" data-category-id="${found.category.id}">${escapeHtml(found.table.name)}</span>`;
          }
        }
        html += `</div></div>`;
      }

      if (hasImage) {
        html += `<div class="click-hint">Click to view card</div>`;
      }

      html += `</div>`;
      container.innerHTML = html;

      // Event listeners
      if (hasImage) {
        document.getElementById('result-card-clickable').addEventListener('click', () => {
          openCardModal(entry);
        });
      }

      container.querySelectorAll('.follow-up-chip').forEach(chip => {
        chip.addEventListener('click', (e) => {
          e.stopPropagation();
          const tableId = chip.dataset.tableId;
          const categoryId = chip.dataset.categoryId;
          selectCategory(categoryId);
          selectTable(tableId);
        });
      });
    }

    function renderEntries() {
      const list = document.getElementById('entries-list');

      if (!selectedCategoryId || !selectedTableId) {
        list.innerHTML = '<div class="empty-state-small">Select a table to see entries</div>';
        return;
      }

      const table = getTable(selectedCategoryId, selectedTableId);
      if (!table || table.entries.length === 0) {
        list.innerHTML = '<div class="empty-state-small">No entries yet. Click + to add one.</div>';
        return;
      }

      list.innerHTML = '';
      table.entries.forEach((entry, index) => {
        const isCard = entry.type === 'card';
        const title = isCard ? (entry.title || 'Untitled') : (entry.text || '').split(/[.!?\n]/)[0].substring(0, 35) || 'Untitled';
        const hasImage = isCard && entry.image;

        const div = document.createElement('div');
        div.className = 'entry-item';
        div.innerHTML = `
          <span class="entry-item-number">${index + 1}</span>
          <span class="entry-item-title">${escapeHtml(title)}</span>
          ${hasImage ? '<span class="entry-item-image">üñº</span>' : ''}
          <div class="entry-item-actions">
            <button data-action="edit" title="Edit">‚úè</button>
            <button data-action="delete" class="danger" title="Delete">‚úï</button>
          </div>
        `;

        // Click to view
        div.addEventListener('click', (e) => {
          if (e.target.closest('.entry-item-actions')) return;
          viewEntryFromList(index);
        });

        // Action buttons
        div.querySelectorAll('button[data-action]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const action = btn.dataset.action;
            if (action === 'edit') {
              editEntryInline(index);
            } else if (action === 'delete') {
              deleteEntryFromList(index);
            }
          });
        });

        list.appendChild(div);
      });
    }

    function viewEntryFromList(index) {
      const table = getTable(selectedCategoryId, selectedTableId);
      if (!table || !table.entries[index]) return;

      const entry = table.entries[index];
      if (entry.type === 'card') {
        openCardModal(entry);
      } else {
        openCardModal({
          type: 'card',
          title: `Entry #${index + 1}`,
          body: entry.text || '',
          effects: null,
          tags: [],
          image: null
        });
      }
    }

    function editEntryInline(index) {
      // Open the inline editor for this entry
      inlineEditorCategoryId = selectedCategoryId;
      inlineEditorTableId = selectedTableId;
      showInlineEditor(index);
      document.getElementById('table-editor-panel').classList.add('active');
      document.getElementById('panel-backdrop').classList.add('active');
    }

    function deleteEntryFromList(index) {
      const table = getTable(selectedCategoryId, selectedTableId);
      if (!table) return;

      showConfirm('Delete Entry', `Delete entry #${index + 1}?`, () => {
        table.entries.splice(index, 1);
        saveData();
        renderEntries();
        closeConfirm();
      });
    }

    function renderDiceButtons() {
      const container = document.getElementById('dice-buttons');
      const dice = [4, 6, 8, 10, 12, 20, 100];
      container.innerHTML = dice.map(d => `<button class="dice-btn" data-dice="${d}">d${d}</button>`).join('');

      container.querySelectorAll('.dice-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const sides = parseInt(btn.dataset.dice);
          const result = rollDice(sides);
          document.getElementById('dice-result').textContent = `d${sides}: ${result}`;
        });
      });
    }

    // ============================================
    // SELECTION & ROLLING
    // ============================================
    function quickAddCategory() {
      showInputModal('Add Category', 'Category name...', (name) => {
        const id = 'cat-' + Date.now();
        appData.categories.push({
          id: id,
          name: name,
          tables: []
        });
        saveData();
        renderCategories();
        selectCategory(id);
        showToast('Category added', 'success');
      });
    }

    function quickAddTable() {
      if (!selectedCategoryId) {
        showToast('Select a category first', 'error');
        return;
      }

      showInputModal('Add Table', 'Table name...', (name) => {
        const category = getCategory(selectedCategoryId);
        if (!category) return;

        const id = 'table-' + Date.now();
        category.tables.push({
          id: id,
          name: name,
          entries: []
        });
        saveData();
        renderTables();
        selectTable(id);
        showToast('Table added', 'success');
      });
    }

    function quickAddEntry() {
      if (!selectedCategoryId || !selectedTableId) {
        showToast('Select a table first', 'error');
        return;
      }

      // Open the inline editor for a new entry
      inlineEditorCategoryId = selectedCategoryId;
      inlineEditorTableId = selectedTableId;
      showInlineEditor();
      document.getElementById('table-editor-panel').classList.add('active');
      document.getElementById('panel-backdrop').classList.add('active');
    }

    function selectCategory(id) {
      selectedCategoryId = id;
      selectedTableId = null;
      renderCategories();
      renderTables();
      renderEntries();
      updateSelectionDisplay();
    }

    function selectTable(id) {
      selectedTableId = id;
      updateSelectionDisplay();
      renderTables();
      renderEntries();
    }

    function rollOnTable() {
      if (!selectedCategoryId || !selectedTableId) return;

      const table = getTable(selectedCategoryId, selectedTableId);
      if (!table || table.entries.length === 0) {
        showToast('Table has no entries', 'error');
        return;
      }

      const rollNumber = rollDice(table.entries.length);
      applyRoll(table, rollNumber);
    }

    function useManualRoll() {
      if (!selectedCategoryId || !selectedTableId) return;

      const table = getTable(selectedCategoryId, selectedTableId);
      if (!table || table.entries.length === 0) {
        showToast('Table has no entries', 'error');
        return;
      }

      const input = document.getElementById('manual-roll-input');
      const value = parseInt(input.value);

      if (isNaN(value) || value < 1 || value > table.entries.length) {
        showToast(`Enter a number between 1 and ${table.entries.length}`, 'error');
        return;
      }

      applyRoll(table, value);
      input.value = '';
    }

    function applyRoll(table, rollNumber) {
      const entry = table.entries[rollNumber - 1];
      rollHistory.unshift({
        tableName: table.name,
        rollNumber: rollNumber,
        entry: entry,
        timestamp: new Date()
      });

      // Keep history reasonable
      if (rollHistory.length > 50) {
        rollHistory = rollHistory.slice(0, 50);
      }

      renderCurrentResult();
      renderHistory();
    }

    // ============================================
    // CARD MODAL
    // ============================================
    function openCardModal(entry) {
      currentCardData = entry;
      const modal = document.getElementById('card-modal');
      const imageArea = document.getElementById('card-image-area');
      const titleEl = document.getElementById('card-title');
      const bodyEl = document.getElementById('card-body');
      const effectsEl = document.getElementById('card-effects');
      const tagsEl = document.getElementById('card-tags');

      if (entry.image) {
        imageArea.innerHTML = `<img src="${entry.image}" alt="">`;
      } else {
        imageArea.innerHTML = `<span class="card-image-placeholder">No image</span>`;
      }

      titleEl.textContent = entry.title || 'Untitled';
      bodyEl.textContent = entry.body || '';
      effectsEl.textContent = entry.effects ? `Effects: ${entry.effects}` : '';
      effectsEl.style.display = entry.effects ? 'block' : 'none';

      if (entry.tags && entry.tags.length > 0) {
        tagsEl.innerHTML = entry.tags.map(t => `<span class="tag">${escapeHtml(t)}</span>`).join('');
        tagsEl.style.display = 'flex';
      } else {
        tagsEl.style.display = 'none';
      }

      modal.classList.add('active');
    }

    function closeCardModal() {
      document.getElementById('card-modal').classList.remove('active');
      currentCardData = null;
    }

    // ============================================
    // GLOBAL SEARCH
    // ============================================
    function openGlobalSearch() {
      const modal = document.getElementById('global-search-modal');
      const input = document.getElementById('global-search-input');
      modal.classList.add('active');
      input.value = '';
      input.focus();
      renderSearchResults('');
    }

    function closeGlobalSearch() {
      document.getElementById('global-search-modal').classList.remove('active');
    }

    function searchAllEntries(query) {
      const results = [];
      const searchTerm = query.toLowerCase().trim();

      if (!searchTerm) return results;

      for (const category of appData.categories) {
        for (const table of category.tables) {
          table.entries.forEach((entry, index) => {
            let matches = false;
            let matchText = '';
            let matchContext = '';

            if (entry.type === 'card') {
              const title = (entry.title || '').toLowerCase();
              const body = (entry.body || '').toLowerCase();
              const effects = (entry.effects || '').toLowerCase();
              const tags = (entry.tags || []).join(' ').toLowerCase();

              if (title.includes(searchTerm)) {
                matches = true;
                matchText = entry.title;
              } else if (body.includes(searchTerm)) {
                matches = true;
                matchText = entry.title || 'Untitled';
                // Show snippet of matching description
                const bodyText = entry.body || '';
                const matchIndex = body.indexOf(searchTerm);
                const start = Math.max(0, matchIndex - 15);
                const end = Math.min(bodyText.length, matchIndex + searchTerm.length + 25);
                matchContext = (start > 0 ? '...' : '') + bodyText.substring(start, end).trim() + (end < bodyText.length ? '...' : '');
              } else if (effects.includes(searchTerm)) {
                matches = true;
                matchText = entry.title || 'Untitled';
                matchContext = 'Effects: ' + (entry.effects || '').substring(0, 35);
              } else if (tags.includes(searchTerm)) {
                matches = true;
                matchText = entry.title || 'Untitled';
                matchContext = 'Tags: ' + (entry.tags || []).join(', ');
              }
            } else {
              const text = (entry.text || '').toLowerCase();
              if (text.includes(searchTerm)) {
                matches = true;
                const fullText = entry.text || '';
                matchText = fullText.split(/[.!?\n]/)[0].substring(0, 35) || 'Untitled';
                const matchIndex = text.indexOf(searchTerm);
                const start = Math.max(0, matchIndex - 15);
                const end = Math.min(fullText.length, matchIndex + searchTerm.length + 25);
                matchContext = (start > 0 ? '...' : '') + fullText.substring(start, end).trim() + (end < fullText.length ? '...' : '');
              }
            }

            if (matches) {
              results.push({
                entry: entry,
                entryIndex: index,
                categoryId: category.id,
                categoryName: category.name,
                tableId: table.id,
                tableName: table.name,
                matchText: matchText,
                matchContext: matchContext
              });
            }
          });
        }
      }

      return results;
    }

    function renderSearchResults(query) {
      const container = document.getElementById('search-results');
      const results = searchAllEntries(query);

      if (!query.trim()) {
        container.innerHTML = `
          <div class="search-empty">
            <div class="search-empty-icon">üîç</div>
            <div>Start typing to search across all tables</div>
          </div>
        `;
        return;
      }

      if (results.length === 0) {
        container.innerHTML = `
          <div class="search-empty">
            <div class="search-empty-icon">üòï</div>
            <div>No entries found for "${escapeHtml(query)}"</div>
          </div>
        `;
        return;
      }

      let html = `<div class="search-result-count">${results.length} result${results.length !== 1 ? 's' : ''} found</div>`;

      for (const result of results) {
        const entry = result.entry;
        const isCard = entry.type === 'card';
        const hasImage = isCard && entry.image;

        html += `
          <div class="search-result-item" data-category-id="${result.categoryId}" data-table-id="${result.tableId}" data-entry-index="${result.entryIndex}">
            <span class="search-result-number">#${result.entryIndex + 1}</span>
            <div class="search-result-content">
              <div class="search-result-title">${escapeHtml(result.matchText)}</div>
              ${result.matchContext ? `<div class="search-result-context">${escapeHtml(result.matchContext)}</div>` : ''}
              <div class="search-result-meta">${escapeHtml(result.categoryName)} ‚Üí ${escapeHtml(result.tableName)}</div>
            </div>
            ${hasImage ? '<span class="search-result-image">üñºÔ∏è</span>' : ''}
          </div>
        `;
      }

      container.innerHTML = html;

      // Add click handlers
      container.querySelectorAll('.search-result-item').forEach(item => {
        item.addEventListener('click', () => {
          const categoryId = item.dataset.categoryId;
          const tableId = item.dataset.tableId;
          const entryIndex = parseInt(item.dataset.entryIndex);

          const category = getCategory(categoryId);
          if (!category) return;

          const table = category.tables.find(t => t.id === tableId);
          if (!table || !table.entries[entryIndex]) return;

          const entry = table.entries[entryIndex];
          closeGlobalSearch();

          if (entry.type === 'card') {
            openCardModal(entry);
          } else {
            openCardModal({
              type: 'card',
              title: `${table.name} #${entryIndex + 1}`,
              body: entry.text || '',
              effects: null,
              tags: [],
              image: null
            });
          }
        });
      });
    }

    function copyCardText() {
      if (!currentCardData) return;

      let text = `**${currentCardData.title || 'Untitled'}**\n`;
      if (currentCardData.body) text += `${currentCardData.body}\n`;
      if (currentCardData.effects) text += `*Effects:* ${currentCardData.effects}`;

      navigator.clipboard.writeText(text).then(() => {
        showToast('Text copied to clipboard', 'success');
      }).catch(() => {
        showToast('Failed to copy text', 'error');
      });
    }

    async function copyCardImage() {
      if (!currentCardData || !currentCardData.image) {
        showToast('No image to copy', 'error');
        return;
      }

      try {
        const canvas = await renderCardToCanvas();
        canvas.toBlob(async (blob) => {
          try {
            await navigator.clipboard.write([
              new ClipboardItem({ 'image/png': blob })
            ]);
            showToast('Image copied to clipboard', 'success');
          } catch (e) {
            showToast('Clipboard image not supported. Use Download PNG instead.', 'error');
          }
        });
      } catch (e) {
        showToast('Failed to render card image', 'error');
      }
    }

    async function downloadCardPng() {
      if (!currentCardData) return;

      try {
        const canvas = await renderCardToCanvas();
        const link = document.createElement('a');
        link.download = `${(currentCardData.title || 'card').replace(/[^a-z0-9]/gi, '_')}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        showToast('Card downloaded', 'success');
      } catch (e) {
        showToast('Failed to download card', 'error');
      }
    }

    function getThemeColors() {
      const style = getComputedStyle(document.documentElement);
      return {
        bgCard: style.getPropertyValue('--bg-card').trim() || '#212d28',
        bgTertiary: style.getPropertyValue('--bg-tertiary').trim() || '#1c2723',
        bgPrimary: style.getPropertyValue('--bg-primary').trim() || '#111816',
        textPrimary: style.getPropertyValue('--text-primary').trim() || '#e4ebe4',
        textSecondary: style.getPropertyValue('--text-secondary').trim() || '#9aaa9a',
        textMuted: style.getPropertyValue('--text-muted').trim() || '#5a6a5a',
        borderStrong: style.getPropertyValue('--border-strong').trim() || '#3a4a42',
        warning: style.getPropertyValue('--warning').trim() || '#8b7355',
        accent: style.getPropertyValue('--accent').trim() || '#4a7c59'
      };
    }

    function renderCardToCanvas() {
      return new Promise((resolve, reject) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const width = 600;
        const padding = 24;
        const textWidth = width - (padding * 2);

        // Get current theme colors
        const colors = getThemeColors();

        // Calculate heights
        ctx.font = 'bold 28px -apple-system, BlinkMacSystemFont, sans-serif';
        const titleLines = wrapText(ctx, currentCardData.title || 'Untitled', textWidth);
        const titleHeight = titleLines.length * 34;

        ctx.font = '18px -apple-system, BlinkMacSystemFont, sans-serif';
        const bodyLines = wrapText(ctx, currentCardData.body || '', textWidth);
        const bodyHeight = bodyLines.length * 26;

        ctx.font = 'italic 16px -apple-system, BlinkMacSystemFont, sans-serif';
        const effectsLines = currentCardData.effects ? wrapText(ctx, 'Effects: ' + currentCardData.effects, textWidth) : [];
        const effectsHeight = effectsLines.length * 22;

        const textSectionHeight = padding + titleHeight + 16 + bodyHeight + (effectsLines.length ? 20 + effectsHeight : 0) + padding;

        // Load image if exists
        if (currentCardData.image) {
          const img = new Image();
          img.onload = () => {
            // Calculate image area height based on aspect ratio
            const imgAspect = img.width / img.height;
            const imgDisplayWidth = width;
            const imgDisplayHeight = Math.min(imgDisplayWidth / imgAspect, 400);

            const height = imgDisplayHeight + textSectionHeight;
            canvas.width = width;
            canvas.height = height;

            // Background
            ctx.fillStyle = colors.bgCard;
            ctx.fillRect(0, 0, width, height);

            // Image
            ctx.drawImage(img, 0, 0, width, imgDisplayHeight);

            // Text area background
            ctx.fillStyle = colors.bgTertiary;
            ctx.fillRect(0, imgDisplayHeight, width, textSectionHeight);

            // Draw text
            let y = imgDisplayHeight + padding;
            ctx.fillStyle = colors.textPrimary;
            ctx.font = 'bold 28px -apple-system, BlinkMacSystemFont, sans-serif';
            for (const line of titleLines) {
              ctx.fillText(line, padding, y + 24);
              y += 34;
            }

            y += 8;
            ctx.fillStyle = colors.textSecondary;
            ctx.font = '18px -apple-system, BlinkMacSystemFont, sans-serif';
            for (const line of bodyLines) {
              ctx.fillText(line, padding, y + 16);
              y += 26;
            }

            if (effectsLines.length) {
              y += 12;
              ctx.fillStyle = colors.warning;
              ctx.font = 'italic 16px -apple-system, BlinkMacSystemFont, sans-serif';
              for (const line of effectsLines) {
                ctx.fillText(line, padding, y + 14);
                y += 22;
              }
            }

            // Border
            ctx.strokeStyle = colors.accent;
            ctx.lineWidth = 4;
            ctx.strokeRect(2, 2, width - 4, height - 4);

            resolve(canvas);
          };
          img.onerror = reject;
          img.src = currentCardData.image;
        } else {
          const height = textSectionHeight + 100;
          canvas.width = width;
          canvas.height = height;

          // Background
          ctx.fillStyle = colors.bgCard;
          ctx.fillRect(0, 0, width, height);

          // Placeholder area
          ctx.fillStyle = colors.bgPrimary;
          ctx.fillRect(0, 0, width, 100);
          ctx.fillStyle = colors.textMuted;
          ctx.font = '16px -apple-system, BlinkMacSystemFont, sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText('No Image', width / 2, 55);
          ctx.textAlign = 'left';

          // Draw text
          let y = 100 + padding;
          ctx.fillStyle = colors.textPrimary;
          ctx.font = 'bold 28px -apple-system, BlinkMacSystemFont, sans-serif';
          for (const line of titleLines) {
            ctx.fillText(line, padding, y + 24);
            y += 34;
          }

          y += 8;
          ctx.fillStyle = colors.textSecondary;
          ctx.font = '18px -apple-system, BlinkMacSystemFont, sans-serif';
          for (const line of bodyLines) {
            ctx.fillText(line, padding, y + 16);
            y += 26;
          }

          if (effectsLines.length) {
            y += 12;
            ctx.fillStyle = colors.warning;
            ctx.font = 'italic 16px -apple-system, BlinkMacSystemFont, sans-serif';
            for (const line of effectsLines) {
              ctx.fillText(line, padding, y + 14);
              y += 22;
            }
          }

          // Border
          ctx.strokeStyle = colors.accent;
          ctx.lineWidth = 4;
          ctx.strokeRect(2, 2, width - 4, height - 4);

          resolve(canvas);
        }
      });
    }

    function wrapText(ctx, text, maxWidth) {
      const words = text.split(' ');
      const lines = [];
      let currentLine = '';

      for (const word of words) {
        const testLine = currentLine ? currentLine + ' ' + word : word;
        const metrics = ctx.measureText(testLine);
        if (metrics.width > maxWidth && currentLine) {
          lines.push(currentLine);
          currentLine = word;
        } else {
          currentLine = testLine;
        }
      }
      if (currentLine) lines.push(currentLine);
      return lines;
    }

    // ============================================
    // WELCOME MODAL & UI HELPERS
    // ============================================
    function showWelcomeModal() {
      if (localStorage.getItem(WELCOME_DISMISSED_KEY) === 'true') return;
      document.getElementById('welcome-modal').classList.add('active');
    }

    function closeWelcomeModal() {
      document.getElementById('welcome-modal').classList.remove('active');
      if (document.getElementById('dont-show-again').checked) {
        localStorage.setItem(WELCOME_DISMISSED_KEY, 'true');
      }
    }

    function openHelpModal() {
      document.getElementById('welcome-modal').classList.add('active');
    }

    function updateSelectionDisplay() {
      const display = document.getElementById('selection-display');
      const step2Badge = document.getElementById('step-2-badge');
      const step3Badge = document.getElementById('step-3-badge');

      if (!selectedCategoryId) {
        display.innerHTML = '<span style="color: var(--text-muted);">Click a category to begin ‚Üí</span>';
        step2Badge.classList.add('waiting');
        step3Badge.classList.add('waiting');
        return;
      }

      const category = getCategory(selectedCategoryId);
      let html = `<span class="selection-bar-value">${escapeHtml(category.name)}</span>`;
      step2Badge.classList.remove('waiting');

      if (selectedTableId) {
        const table = getTable(selectedCategoryId, selectedTableId);
        if (table) {
          html += ` <span class="selection-bar-separator">‚Üí</span> <span class="selection-bar-value">${escapeHtml(table.name)}</span>`;
          html += ` <span style="color: var(--text-muted);">(${table.entries.length} entries, ${getDiceNotation(table.entries.length)})</span>`;
          step3Badge.classList.remove('waiting');
        }
      } else {
        html += ` <span class="selection-bar-separator">‚Üí</span> <span style="color: var(--text-muted);">Select a table</span>`;
        step3Badge.classList.add('waiting');
      }

      display.innerHTML = html;
    }

    // ============================================
    // TABLE EDITOR PANEL
    // ============================================
    function openTableEditorPanel() {
      if (!selectedCategoryId || !selectedTableId) return;

      inlineEditorCategoryId = selectedCategoryId;
      inlineEditorTableId = selectedTableId;
      inlineEditingIndex = null;
      inlineImageData = null;

      const table = getTable(inlineEditorCategoryId, inlineEditorTableId);
      if (!table) return;

      document.getElementById('editor-panel-title').textContent = table.name;
      updateEditorEntryCount();
      renderQuickEntryList();
      hideInlineEditor();
      populateInlineFollowupSelect();

      document.getElementById('table-editor-panel').classList.add('active');
      document.getElementById('panel-backdrop').classList.add('active');
    }

    function closeTableEditorPanel() {
      document.getElementById('table-editor-panel').classList.remove('active');
      document.getElementById('panel-backdrop').classList.remove('active');
      hideInlineEditor();
      inlineEditorCategoryId = null;
      inlineEditorTableId = null;
      renderTables();
      renderEntries();
    }

    function updateEditorEntryCount() {
      const table = getTable(inlineEditorCategoryId, inlineEditorTableId);
      if (table) {
        const count = table.entries.length;
        const diceStr = count > 0 ? ` ‚Ä¢ ${getDiceNotation(count)}` : '';
        document.getElementById('editor-entry-count').textContent = `${count}/100${diceStr}`;
      }
    }

    function renderQuickEntryList() {
      const table = getTable(inlineEditorCategoryId, inlineEditorTableId);
      const list = document.getElementById('quick-entry-list');

      if (!table || table.entries.length === 0) {
        list.innerHTML = '<div class="editor-empty">No entries yet. Add your first entry above!</div>';
        return;
      }

      list.innerHTML = '';
      table.entries.forEach((entry, index) => {
        // Handle both old "text" entries and new "card" entries
        const isCard = entry.type === 'card';
        const title = isCard ? (entry.title || 'Untitled') : (entry.text || '').split(/[.!?\n]/)[0].substring(0, 40) || 'Untitled';
        const hasImage = isCard && entry.image;
        const isEditing = index === inlineEditingIndex;

        const item = document.createElement('div');
        item.className = 'quick-entry-item' + (isEditing ? ' editing' : '');
        item.innerHTML = `
          <span class="quick-entry-number">${index + 1}</span>
          <span class="quick-entry-preview" data-index="${index}" title="Click to view">${escapeHtml(title)}</span>
          ${hasImage ? '<span class="quick-entry-image-indicator">üñºÔ∏è</span>' : ''}
          <div class="quick-entry-actions">
            <button data-action="view" data-index="${index}" title="View">üëÅÔ∏è</button>
            <button data-action="up" data-index="${index}" ${index === 0 ? 'disabled' : ''} title="Move up">‚Üë</button>
            <button data-action="down" data-index="${index}" ${index === table.entries.length - 1 ? 'disabled' : ''} title="Move down">‚Üì</button>
            <button data-action="edit" data-index="${index}" title="Edit">‚úèÔ∏è</button>
            <button data-action="duplicate" data-index="${index}" title="Duplicate">üìã</button>
            <button data-action="delete" data-index="${index}" class="danger" title="Delete">üóëÔ∏è</button>
          </div>
        `;
        list.appendChild(item);
      });

      // Event delegation for entry list - click preview to view the entry
      list.querySelectorAll('.quick-entry-preview').forEach(el => {
        el.addEventListener('click', () => viewEntry(parseInt(el.dataset.index)));
      });

      list.querySelectorAll('button[data-action]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const action = btn.dataset.action;
          const index = parseInt(btn.dataset.index);

          switch (action) {
            case 'view': viewEntry(index); break;
            case 'up': moveEntry(index, -1); break;
            case 'down': moveEntry(index, 1); break;
            case 'edit': editQuickEntry(index); break;
            case 'duplicate': duplicateEntry(index); break;
            case 'delete': deleteQuickEntry(index); break;
          }
        });
      });
    }

    function populateInlineFollowupSelect() {
      const select = document.getElementById('inline-card-followup');
      const allTables = getAllTables();
      select.innerHTML = allTables.map(t =>
        `<option value="${t.id}">${escapeHtml(t.categoryName)}: ${escapeHtml(t.name)}</option>`
      ).join('');
    }

    function showInlineEditor(index = null) {
      const table = getTable(inlineEditorCategoryId, inlineEditorTableId);
      if (!table) return;

      // Check limit for new entries
      if (index === null && table.entries.length >= 100) {
        showToast('Maximum 100 entries per table', 'error');
        return;
      }

      inlineEditingIndex = index;
      inlineImageData = null;

      const editor = document.getElementById('inline-entry-editor');
      const titleEl = document.getElementById('inline-editor-title');
      const deleteBtn = document.getElementById('btn-delete-inline-entry');

      if (index !== null) {
        titleEl.textContent = `Edit Entry #${index + 1}`;
        deleteBtn.classList.remove('hidden');
        const entry = table.entries[index];
        populateInlineEditor(entry);
      } else {
        titleEl.textContent = 'New Entry';
        deleteBtn.classList.add('hidden');
        clearInlineEditor();
      }

      editor.classList.remove('hidden');
      renderQuickEntryList();

      // Scroll to editor and focus title
      editor.scrollIntoView({ behavior: 'smooth', block: 'start' });
      setTimeout(() => document.getElementById('inline-card-title').focus(), 100);
    }

    function hideInlineEditor() {
      document.getElementById('inline-entry-editor').classList.add('hidden');
      inlineEditingIndex = null;
      inlineImageData = null;
      renderQuickEntryList();
    }

    function clearInlineEditor() {
      document.getElementById('inline-card-title').value = '';
      document.getElementById('inline-card-body').value = '';
      document.getElementById('inline-card-effects').value = '';
      document.getElementById('inline-card-tags').value = '';
      inlineImageData = null;

      const imageUpload = document.getElementById('inline-image-upload');
      imageUpload.innerHTML = '<span class="inline-image-upload-text">Click to upload image</span>';
      imageUpload.classList.remove('has-image');

      const followupSelect = document.getElementById('inline-card-followup');
      Array.from(followupSelect.options).forEach(opt => opt.selected = false);
    }

    function populateInlineEditor(entry) {
      // Handle both old "text" entries and "card" entries
      if (entry.type === 'text') {
        // Convert old text entry: use text as body, generate title from first words
        const text = entry.text || '';
        const autoTitle = text.split(/[.!?\n]/)[0].substring(0, 50).trim() || 'Untitled';
        document.getElementById('inline-card-title').value = autoTitle;
        document.getElementById('inline-card-body').value = text;
        document.getElementById('inline-card-effects').value = '';
        document.getElementById('inline-card-tags').value = '';
        inlineImageData = null;
      } else {
        document.getElementById('inline-card-title').value = entry.title || '';
        document.getElementById('inline-card-body').value = entry.body || '';
        document.getElementById('inline-card-effects').value = entry.effects || '';
        document.getElementById('inline-card-tags').value = (entry.tags || []).join(', ');
        inlineImageData = entry.image || null;
      }

      const imageUpload = document.getElementById('inline-image-upload');
      if (inlineImageData) {
        imageUpload.innerHTML = `<img src="${inlineImageData}" alt="">`;
        imageUpload.classList.add('has-image');
      } else {
        imageUpload.innerHTML = '<span class="inline-image-upload-text">Click to upload image</span>';
        imageUpload.classList.remove('has-image');
      }

      const followupSelect = document.getElementById('inline-card-followup');
      Array.from(followupSelect.options).forEach(opt => {
        opt.selected = (entry.followUpTables || []).includes(opt.value);
      });
    }

    function saveInlineEntry() {
      const table = getTable(inlineEditorCategoryId, inlineEditorTableId);
      if (!table) return;

      const title = document.getElementById('inline-card-title').value.trim();
      const body = document.getElementById('inline-card-body').value.trim();

      if (!title) {
        showToast('Title is required', 'error');
        return;
      }

      if (!body) {
        showToast('Description is required', 'error');
        return;
      }

      const tagsStr = document.getElementById('inline-card-tags').value;
      const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [];

      const followupSelect = document.getElementById('inline-card-followup');
      const followUpTables = Array.from(followupSelect.selectedOptions).map(opt => opt.value);

      const entry = {
        type: 'card',
        title: title,
        body: body,
        effects: document.getElementById('inline-card-effects').value.trim(),
        tags: tags,
        followUpTables: followUpTables,
        image: inlineImageData
      };

      if (inlineEditingIndex !== null) {
        table.entries[inlineEditingIndex] = entry;
        showToast('Entry updated', 'success');
      } else {
        table.entries.push(entry);
        showToast('Entry added', 'success');
      }

      saveData();
      hideInlineEditor();
      updateEditorEntryCount();
      renderQuickEntryList();
      renderEntries();
    }

    function viewEntry(index) {
      const table = getTable(inlineEditorCategoryId, inlineEditorTableId);
      if (!table || !table.entries[index]) return;

      const entry = table.entries[index];
      // Handle both old "text" entries and "card" entries
      if (entry.type === 'text') {
        openCardModal({
          type: 'card',
          title: `Entry #${index + 1}`,
          body: entry.text || '',
          effects: null,
          tags: [],
          image: null
        });
      } else {
        openCardModal(entry);
      }
    }

    function editQuickEntry(index) {
      const table = getTable(inlineEditorCategoryId, inlineEditorTableId);
      if (!table || !table.entries[index]) return;

      showInlineEditor(index);
    }

    function deleteQuickEntry(index) {
      const table = getTable(inlineEditorCategoryId, inlineEditorTableId);
      if (!table) return;

      showConfirm('Delete Entry', `Delete entry #${index + 1}?`, () => {
        table.entries.splice(index, 1);
        saveData();

        if (inlineEditingIndex === index) {
          hideInlineEditor();
        } else if (inlineEditingIndex !== null && inlineEditingIndex > index) {
          inlineEditingIndex--;
        }

        updateEditorEntryCount();
        renderQuickEntryList();
        renderEntries();
        closeConfirm();
        showToast('Entry deleted', 'success');
      });
    }

    function moveEntry(index, direction) {
      const table = getTable(inlineEditorCategoryId, inlineEditorTableId);
      if (!table) return;

      const newIndex = index + direction;
      if (newIndex < 0 || newIndex >= table.entries.length) return;

      // Swap entries
      [table.entries[index], table.entries[newIndex]] = [table.entries[newIndex], table.entries[index]];

      // Update editing index if needed
      if (inlineEditingIndex === index) {
        inlineEditingIndex = newIndex;
      } else if (inlineEditingIndex === newIndex) {
        inlineEditingIndex = index;
      }

      saveData();
      renderQuickEntryList();
    }

    function duplicateEntry(index) {
      const table = getTable(inlineEditorCategoryId, inlineEditorTableId);
      if (!table || table.entries.length >= 100) {
        showToast('Maximum 100 entries per table', 'error');
        return;
      }

      const original = table.entries[index];
      const copy = JSON.parse(JSON.stringify(original));

      // Insert after the original
      table.entries.splice(index + 1, 0, copy);

      saveData();
      updateEditorEntryCount();
      renderQuickEntryList();
      showToast('Entry duplicated', 'success');
    }

    async function handleInlineImageUpload(file) {
      try {
        const result = await processImageUpload(file);
        if (!result) return;

        inlineImageData = result;
        const uploadArea = document.getElementById('inline-image-upload');

        // For path-based images, show a placeholder until file is saved
        if (!result.startsWith('data:')) {
          uploadArea.innerHTML = `<div style="padding: 0.5rem; text-align: center; font-size: 0.75rem;">Image: ${result}<br><small>(save downloaded file to folder)</small></div>`;
        } else {
          uploadArea.innerHTML = `<img src="${result}" alt="">`;
        }
        uploadArea.classList.add('has-image');
      } catch (e) {
        showToast('Failed to load image', 'error');
      }
    }

    function clearInlineImage() {
      inlineImageData = null;
      const uploadArea = document.getElementById('inline-image-upload');
      uploadArea.innerHTML = '<span class="inline-image-upload-text">Click to upload image</span>';
      uploadArea.classList.remove('has-image');
    }

    function previewInlineCard() {
      const title = document.getElementById('inline-card-title').value.trim() || 'Untitled';
      const body = document.getElementById('inline-card-body').value.trim();
      const effects = document.getElementById('inline-card-effects').value.trim();
      const tagsStr = document.getElementById('inline-card-tags').value;
      const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [];

      openCardModal({
        type: 'card',
        title: title,
        body: body,
        effects: effects,
        tags: tags,
        image: inlineImageData
      });
    }

    // ============================================
    // SETTINGS MODAL
    // ============================================
    function openSettings() {
      document.getElementById('settings-modal').classList.add('active');
      renderSettingsCategories();
      renderSettingsCategorySelect();
      renderEntriesCategorySelect();
      renderBackgroundPreview();
    }

    function closeSettings() {
      document.getElementById('settings-modal').classList.remove('active');
      renderAll();
    }

    function switchSettingsTab(tab) {
      document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.settings-panel').forEach(p => p.classList.remove('active'));
      document.querySelector(`.settings-tab[data-tab="${tab}"]`).classList.add('active');
      document.getElementById('panel-' + tab).classList.add('active');

      if (tab === 'tables') {
        renderSettingsCategorySelect();
        renderSettingsTables();
      } else if (tab === 'entries') {
        renderEntriesCategorySelect();
        renderEntriesTableSelect();
        renderSettingsEntries();
      }
    }

    // Categories editor
    function renderSettingsCategories() {
      const list = document.getElementById('settings-categories-list');
      if (appData.categories.length === 0) {
        list.innerHTML = '<div class="editor-empty">No categories</div>';
        return;
      }

      list.innerHTML = '';
      for (const cat of appData.categories) {
        const item = document.createElement('div');
        item.className = 'editor-list-item' + (cat.id === editingCategoryId ? ' selected' : '');
        item.innerHTML = `
          <span class="editor-list-item-name">${escapeHtml(cat.name)}</span>
          <div class="editor-list-item-actions">
            <button class="small" data-action="edit" data-id="${cat.id}">Edit</button>
            <button class="small danger" data-action="delete" data-id="${cat.id}">Delete</button>
          </div>
        `;
        list.appendChild(item);
      }

      list.querySelectorAll('button[data-action="edit"]').forEach(btn => {
        btn.addEventListener('click', () => editCategory(btn.dataset.id));
      });
      list.querySelectorAll('button[data-action="delete"]').forEach(btn => {
        btn.addEventListener('click', () => deleteCategory(btn.dataset.id));
      });
    }

    function addCategory() {
      editingCategoryId = null;
      document.getElementById('category-name-input').value = '';
      document.getElementById('category-editor').classList.remove('hidden');
    }

    function editCategory(id) {
      const cat = getCategory(id);
      if (!cat) return;
      editingCategoryId = id;
      document.getElementById('category-name-input').value = cat.name;
      document.getElementById('category-editor').classList.remove('hidden');
      renderSettingsCategories();
    }

    function saveCategory() {
      const name = document.getElementById('category-name-input').value.trim();
      if (!name) {
        showToast('Name is required', 'error');
        return;
      }

      if (editingCategoryId) {
        const cat = getCategory(editingCategoryId);
        if (cat) cat.name = name;
      } else {
        appData.categories.push({
          id: generateId(),
          name: name,
          tables: []
        });
      }

      saveData();
      cancelCategoryEdit();
      renderSettingsCategories();
      renderSettingsCategorySelect();
      renderEntriesCategorySelect();
    }

    function cancelCategoryEdit() {
      editingCategoryId = null;
      document.getElementById('category-editor').classList.add('hidden');
      renderSettingsCategories();
    }

    function deleteCategory(id) {
      const cat = getCategory(id);
      if (!cat) return;

      showConfirm('Delete Category', `Delete "${cat.name}" and all its tables?`, () => {
        appData.categories = appData.categories.filter(c => c.id !== id);
        if (selectedCategoryId === id) {
          selectedCategoryId = null;
          selectedTableId = null;
        }
        saveData();
        renderSettingsCategories();
        renderSettingsCategorySelect();
        renderEntriesCategorySelect();
        closeConfirm();
      });
    }

    // Tables editor
    function renderSettingsCategorySelect() {
      const select = document.getElementById('settings-category-select');
      select.innerHTML = appData.categories.map(c =>
        `<option value="${c.id}">${escapeHtml(c.name)}</option>`
      ).join('');
      renderSettingsTables();
    }

    function renderSettingsTables() {
      const select = document.getElementById('settings-category-select');
      const catId = select.value;
      const cat = getCategory(catId);
      const list = document.getElementById('settings-tables-list');

      if (!cat || cat.tables.length === 0) {
        list.innerHTML = '<div class="editor-empty">No tables</div>';
        return;
      }

      list.innerHTML = '';
      for (const table of cat.tables) {
        const item = document.createElement('div');
        item.className = 'editor-list-item' + (table.id === editingTableId ? ' selected' : '');
        item.innerHTML = `
          <span class="editor-list-item-name">${escapeHtml(table.name)} (${table.entries.length})</span>
          <div class="editor-list-item-actions">
            <button class="small" data-action="edit" data-id="${table.id}">Edit</button>
            <button class="small danger" data-action="delete" data-id="${table.id}">Delete</button>
          </div>
        `;
        list.appendChild(item);
      }

      list.querySelectorAll('button[data-action="edit"]').forEach(btn => {
        btn.addEventListener('click', () => editTable(btn.dataset.id));
      });
      list.querySelectorAll('button[data-action="delete"]').forEach(btn => {
        btn.addEventListener('click', () => deleteTable(btn.dataset.id));
      });
    }

    function addTable() {
      const catId = document.getElementById('settings-category-select').value;
      if (!catId) {
        showToast('Select a category first', 'error');
        return;
      }
      editingTableId = null;
      document.getElementById('table-name-input').value = '';
      document.getElementById('table-editor').classList.remove('hidden');
    }

    function editTable(id) {
      const catId = document.getElementById('settings-category-select').value;
      const table = getTable(catId, id);
      if (!table) return;
      editingTableId = id;
      document.getElementById('table-name-input').value = table.name;
      document.getElementById('table-editor').classList.remove('hidden');
      renderSettingsTables();
    }

    function saveTable() {
      const name = document.getElementById('table-name-input').value.trim();
      if (!name) {
        showToast('Name is required', 'error');
        return;
      }

      const catId = document.getElementById('settings-category-select').value;
      const cat = getCategory(catId);
      if (!cat) return;

      if (editingTableId) {
        const table = cat.tables.find(t => t.id === editingTableId);
        if (table) table.name = name;
      } else {
        cat.tables.push({
          id: generateId(),
          name: name,
          entries: []
        });
      }

      saveData();
      cancelTableEdit();
      renderSettingsTables();
      renderEntriesTableSelect();
    }

    function cancelTableEdit() {
      editingTableId = null;
      document.getElementById('table-editor').classList.add('hidden');
      renderSettingsTables();
    }

    function deleteTable(id) {
      const catId = document.getElementById('settings-category-select').value;
      const table = getTable(catId, id);
      if (!table) return;

      showConfirm('Delete Table', `Delete "${table.name}" and all its entries?`, () => {
        const cat = getCategory(catId);
        cat.tables = cat.tables.filter(t => t.id !== id);
        if (selectedTableId === id) {
          selectedTableId = null;
        }
        saveData();
        renderSettingsTables();
        renderEntriesTableSelect();
        closeConfirm();
      });
    }

    // Entries editor
    function renderEntriesCategorySelect() {
      const select = document.getElementById('entries-category-select');
      select.innerHTML = appData.categories.map(c =>
        `<option value="${c.id}">${escapeHtml(c.name)}</option>`
      ).join('');
      renderEntriesTableSelect();
    }

    function renderEntriesTableSelect() {
      const catSelect = document.getElementById('entries-category-select');
      const tableSelect = document.getElementById('entries-table-select');
      const cat = getCategory(catSelect.value);

      if (!cat || cat.tables.length === 0) {
        tableSelect.innerHTML = '<option value="">No tables</option>';
        renderSettingsEntries();
        return;
      }

      tableSelect.innerHTML = cat.tables.map(t =>
        `<option value="${t.id}">${escapeHtml(t.name)}</option>`
      ).join('');
      renderSettingsEntries();
    }

    function renderSettingsEntries() {
      const catId = document.getElementById('entries-category-select').value;
      const tableId = document.getElementById('entries-table-select').value;
      const table = getTable(catId, tableId);
      const list = document.getElementById('settings-entries-list');
      const countEl = document.getElementById('entry-count');

      if (!table) {
        list.innerHTML = '<div class="editor-empty">Select a table</div>';
        countEl.textContent = '(0/100)';
        return;
      }

      countEl.textContent = `(${table.entries.length}/100)`;

      if (table.entries.length === 0) {
        list.innerHTML = '<div class="editor-empty">No entries</div>';
        return;
      }

      list.innerHTML = '';
      table.entries.forEach((entry, index) => {
        const displayText = entry.type === 'card'
          ? `[Card] ${entry.title || 'Untitled'}`
          : (entry.text || '').substring(0, 40) + ((entry.text || '').length > 40 ? '...' : '');

        const item = document.createElement('div');
        item.className = 'editor-list-item' + (index === editingEntryIndex ? ' selected' : '');
        item.innerHTML = `
          <span class="editor-list-item-name">${index + 1}. ${escapeHtml(displayText)}</span>
          <div class="editor-list-item-actions">
            <button class="small" data-action="edit" data-index="${index}">Edit</button>
            <button class="small danger" data-action="delete" data-index="${index}">Delete</button>
          </div>
        `;
        list.appendChild(item);
      });

      list.querySelectorAll('button[data-action="edit"]').forEach(btn => {
        btn.addEventListener('click', () => editEntry(parseInt(btn.dataset.index)));
      });
      list.querySelectorAll('button[data-action="delete"]').forEach(btn => {
        btn.addEventListener('click', () => deleteEntry(parseInt(btn.dataset.index)));
      });

      // Populate follow-up select
      const followupSelect = document.getElementById('entry-followup-select');
      const allTables = getAllTables();
      followupSelect.innerHTML = allTables.map(t =>
        `<option value="${t.id}">${escapeHtml(t.categoryName)}: ${escapeHtml(t.name)}</option>`
      ).join('');
    }

    function addEntry() {
      const catId = document.getElementById('entries-category-select').value;
      const tableId = document.getElementById('entries-table-select').value;
      const table = getTable(catId, tableId);

      if (!table) {
        showToast('Select a table first', 'error');
        return;
      }

      if (table.entries.length >= 100) {
        showToast('Maximum 100 entries per table', 'error');
        return;
      }

      editingEntryIndex = null;
      entryImageData = null;
      resetEntryForm();
      document.getElementById('entry-editor').classList.remove('hidden');
    }

    function editEntry(index) {
      const catId = document.getElementById('entries-category-select').value;
      const tableId = document.getElementById('entries-table-select').value;
      const table = getTable(catId, tableId);
      if (!table || !table.entries[index]) return;

      const entry = table.entries[index];
      editingEntryIndex = index;
      entryImageData = entry.image || null;

      // Handle both old "text" entries and "card" entries
      if (entry.type === 'text') {
        const text = entry.text || '';
        const autoTitle = text.split(/[.!?\n]/)[0].substring(0, 50).trim() || 'Untitled';
        document.getElementById('entry-title-input').value = autoTitle;
        document.getElementById('entry-body-input').value = text;
        document.getElementById('entry-effects-input').value = '';
        document.getElementById('entry-tags-input').value = '';
      } else {
        document.getElementById('entry-title-input').value = entry.title || '';
        document.getElementById('entry-body-input').value = entry.body || '';
        document.getElementById('entry-effects-input').value = entry.effects || '';
        document.getElementById('entry-tags-input').value = (entry.tags || []).join(', ');
      }

      // Set follow-up tables
      const followupSelect = document.getElementById('entry-followup-select');
      Array.from(followupSelect.options).forEach(opt => {
        opt.selected = (entry.followUpTables || []).includes(opt.value);
      });

      // Set image preview
      const uploadArea = document.getElementById('entry-image-upload');
      if (entryImageData) {
        uploadArea.innerHTML = `<img src="${entryImageData}" alt="">`;
        uploadArea.classList.add('has-image');
      } else {
        uploadArea.innerHTML = '<span class="image-upload-text">Click or drag to upload image</span>';
        uploadArea.classList.remove('has-image');
      }

      document.getElementById('entry-editor').classList.remove('hidden');
      renderSettingsEntries();
    }

    function resetEntryForm() {
      document.getElementById('entry-title-input').value = '';
      document.getElementById('entry-body-input').value = '';
      document.getElementById('entry-effects-input').value = '';
      document.getElementById('entry-tags-input').value = '';

      const followupSelect = document.getElementById('entry-followup-select');
      Array.from(followupSelect.options).forEach(opt => opt.selected = false);

      const uploadArea = document.getElementById('entry-image-upload');
      uploadArea.innerHTML = '<span class="image-upload-text">Click or drag to upload image</span>';
      uploadArea.classList.remove('has-image');
    }

    function saveEntry() {
      const catId = document.getElementById('entries-category-select').value;
      const tableId = document.getElementById('entries-table-select').value;
      const table = getTable(catId, tableId);
      if (!table) return;

      const title = document.getElementById('entry-title-input').value.trim();
      const body = document.getElementById('entry-body-input').value.trim();

      if (!title) {
        showToast('Title is required', 'error');
        return;
      }

      if (!body) {
        showToast('Description is required', 'error');
        return;
      }

      const tagsStr = document.getElementById('entry-tags-input').value;
      const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [];

      const followupSelect = document.getElementById('entry-followup-select');
      const followUpTables = Array.from(followupSelect.selectedOptions).map(opt => opt.value);

      const entry = {
        type: 'card',
        title: title,
        body: body,
        effects: document.getElementById('entry-effects-input').value.trim(),
        tags: tags,
        followUpTables: followUpTables,
        image: entryImageData
      };

      if (editingEntryIndex !== null) {
        table.entries[editingEntryIndex] = entry;
      } else {
        table.entries.push(entry);
      }

      saveData();
      cancelEntryEdit();
      renderSettingsEntries();
    }

    function cancelEntryEdit() {
      editingEntryIndex = null;
      entryImageData = null;
      document.getElementById('entry-editor').classList.add('hidden');
      renderSettingsEntries();
    }

    function deleteEntry(index) {
      const catId = document.getElementById('entries-category-select').value;
      const tableId = document.getElementById('entries-table-select').value;
      const table = getTable(catId, tableId);
      if (!table) return;

      showConfirm('Delete Entry', 'Delete this entry?', () => {
        table.entries.splice(index, 1);
        saveData();
        renderSettingsEntries();
        closeConfirm();
      });
    }


    async function handleEntryImageUpload(file) {
      try {
        const result = await processImageUpload(file);
        if (!result) return;

        entryImageData = result;
        const uploadArea = document.getElementById('entry-image-upload');

        // For path-based images, show a placeholder until file is saved
        if (!result.startsWith('data:')) {
          uploadArea.innerHTML = `<div style="padding: 0.5rem; text-align: center; font-size: 0.75rem;">Image: ${result}<br><small>(save downloaded file to folder)</small></div>`;
        } else {
          uploadArea.innerHTML = `<img src="${result}" alt="">`;
        }
        uploadArea.classList.add('has-image');
      } catch (e) {
        showToast('Failed to load image', 'error');
      }
    }

    function clearEntryImage() {
      entryImageData = null;
      const uploadArea = document.getElementById('entry-image-upload');
      uploadArea.innerHTML = '<span class="image-upload-text">Click or drag to upload image</span>';
      uploadArea.classList.remove('has-image');
    }

    function previewEntryCard() {
      const title = document.getElementById('entry-title-input').value.trim() || 'Untitled';
      const body = document.getElementById('entry-body-input').value.trim();
      const effects = document.getElementById('entry-effects-input').value.trim();
      const tagsStr = document.getElementById('entry-tags-input').value;
      const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [];

      openCardModal({
        type: 'card',
        title: title,
        body: body,
        effects: effects,
        tags: tags,
        image: entryImageData
      });
    }

    // Background settings
    function renderBackgroundPreview() {
      const preview = document.getElementById('bg-preview');
      const img = appData.backgroundImage || pendingBackgroundImage;
      if (img) {
        preview.innerHTML = `<img src="${img}" alt="">`;
      } else {
        preview.innerHTML = '<span class="bg-preview-placeholder">No background image set</span>';
      }
    }

    async function handleBackgroundUpload(file) {
      if (!file || !file.type.startsWith('image/')) {
        showToast('Please select an image file', 'error');
        return;
      }

      try {
        pendingBackgroundImage = await fileToDataUrl(file);
        renderBackgroundPreview();
      } catch (e) {
        showToast('Failed to load image', 'error');
      }
    }

    function saveBackground() {
      if (pendingBackgroundImage) {
        appData.backgroundImage = pendingBackgroundImage;
        pendingBackgroundImage = null;
        saveData();
        renderBackground();
        showToast('Background saved', 'success');
      } else {
        showToast('No new background to save', 'error');
      }
    }

    function clearBackground() {
      appData.backgroundImage = null;
      pendingBackgroundImage = null;
      saveData();
      renderBackground();
      renderBackgroundPreview();
      showToast('Background cleared', 'success');
    }

    // Import/Export
    function exportJson() {
      const dataStr = JSON.stringify(appData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const link = document.createElement('a');
      link.download = 'oakhart-rolltables-export.json';
      link.href = URL.createObjectURL(blob);
      link.click();
      URL.revokeObjectURL(link.href);
      showToast('Data exported', 'success');
    }

    function importJson(file) {
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const imported = JSON.parse(e.target.result);
          if (!imported.categories || !Array.isArray(imported.categories)) {
            throw new Error('Invalid format');
          }

          showConfirm('Import Data', 'This will replace all your current tables. Continue?', () => {
            appData = { ...imported, version: DATA_VERSION };
            saveData();
            selectedCategoryId = null;
            selectedTableId = null;
            renderAll();
            renderSettingsCategories();
            renderSettingsCategorySelect();
            renderEntriesCategorySelect();
            closeConfirm();
            showToast('Data imported successfully', 'success');
          });
        } catch (err) {
          showToast('Invalid JSON file', 'error');
        }
      };
      reader.readAsText(file);
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================
    function initEventListeners() {
      // Header
      document.getElementById('btn-global-search').addEventListener('click', openGlobalSearch);
      document.getElementById('btn-settings').addEventListener('click', openSettings);
      document.getElementById('btn-help').addEventListener('click', openHelpModal);

      // Global search modal
      document.getElementById('global-search-modal').querySelector('.modal-close').addEventListener('click', closeGlobalSearch);
      document.getElementById('global-search-modal').addEventListener('click', (e) => {
        if (e.target.id === 'global-search-modal') closeGlobalSearch();
      });
      document.getElementById('global-search-input').addEventListener('input', (e) => {
        renderSearchResults(e.target.value);
      });

      // Keyboard shortcut for global search (Ctrl+K or Cmd+K)
      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
          e.preventDefault();
          openGlobalSearch();
        }
        // Close search on Escape
        if (e.key === 'Escape' && document.getElementById('global-search-modal').classList.contains('active')) {
          closeGlobalSearch();
        }
      });

      // Welcome modal
      document.getElementById('welcome-modal').querySelector('.modal-close').addEventListener('click', closeWelcomeModal);
      document.getElementById('btn-welcome-start').addEventListener('click', closeWelcomeModal);

      // Category search
      document.getElementById('category-search').addEventListener('input', renderCategories);

      // Table search
      document.getElementById('table-search').addEventListener('input', renderTables);

      // Quick add buttons
      document.getElementById('btn-add-category-quick').addEventListener('click', quickAddCategory);
      document.getElementById('btn-add-table-quick').addEventListener('click', quickAddTable);
      document.getElementById('btn-add-entry-quick').addEventListener('click', quickAddEntry);

      // Card modal
      document.getElementById('card-modal').querySelector('.modal-close').addEventListener('click', closeCardModal);
      document.getElementById('btn-close-card').addEventListener('click', closeCardModal);
      document.getElementById('btn-copy-text').addEventListener('click', copyCardText);
      document.getElementById('btn-copy-image').addEventListener('click', copyCardImage);
      document.getElementById('btn-download-card').addEventListener('click', downloadCardPng);

      // Settings modal
      document.getElementById('settings-modal').querySelector('.modal-close').addEventListener('click', closeSettings);
      document.getElementById('btn-close-settings').addEventListener('click', closeSettings);

      // Settings tabs
      document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.addEventListener('click', () => switchSettingsTab(tab.dataset.tab));
      });

      // Categories editor
      document.getElementById('btn-add-category').addEventListener('click', addCategory);
      document.getElementById('btn-save-category').addEventListener('click', saveCategory);
      document.getElementById('btn-cancel-category').addEventListener('click', cancelCategoryEdit);

      // Tables editor
      document.getElementById('settings-category-select').addEventListener('change', renderSettingsTables);
      document.getElementById('btn-add-table').addEventListener('click', addTable);
      document.getElementById('btn-save-table').addEventListener('click', saveTable);
      document.getElementById('btn-cancel-table').addEventListener('click', cancelTableEdit);

      // Entries editor
      document.getElementById('entries-category-select').addEventListener('change', () => {
        renderEntriesTableSelect();
        renderSettingsEntries();
      });
      document.getElementById('entries-table-select').addEventListener('change', renderSettingsEntries);
      document.getElementById('btn-add-entry').addEventListener('click', addEntry);
      document.getElementById('btn-save-entry').addEventListener('click', saveEntry);
      document.getElementById('btn-cancel-entry').addEventListener('click', cancelEntryEdit);

      // Entry image upload
      const entryImageUpload = document.getElementById('entry-image-upload');
      const entryImageFile = document.getElementById('entry-image-file');
      entryImageUpload.addEventListener('click', () => entryImageFile.click());
      entryImageUpload.addEventListener('dragover', (e) => { e.preventDefault(); });
      entryImageUpload.addEventListener('drop', (e) => {
        e.preventDefault();
        handleEntryImageUpload(e.dataTransfer.files[0]);
      });
      entryImageFile.addEventListener('change', () => {
        handleEntryImageUpload(entryImageFile.files[0]);
        entryImageFile.value = '';
      });
      document.getElementById('btn-clear-entry-image').addEventListener('click', clearEntryImage);
      document.getElementById('btn-preview-card').addEventListener('click', previewEntryCard);

      // Title and Theme
      document.getElementById('btn-save-title').addEventListener('click', () => {
        const titleInput = document.getElementById('app-title-input');
        const newTitle = titleInput.value.trim() || 'Oakhart Roll Tables';
        applyTitle(newTitle);
        showToast('Title updated', 'success');
      });

      document.getElementById('theme-select').addEventListener('change', (e) => {
        updateThemePreview(e.target.value);
      });

      document.getElementById('btn-apply-theme').addEventListener('click', () => {
        const themeSelect = document.getElementById('theme-select');
        applyTheme(themeSelect.value);
        showToast('Theme applied', 'success');
      });

      // Background upload
      const bgImageUpload = document.getElementById('bg-image-upload');
      const bgImageFile = document.getElementById('bg-image-file');
      bgImageUpload.addEventListener('click', () => bgImageFile.click());
      bgImageUpload.addEventListener('dragover', (e) => { e.preventDefault(); });
      bgImageUpload.addEventListener('drop', (e) => {
        e.preventDefault();
        handleBackgroundUpload(e.dataTransfer.files[0]);
      });
      bgImageFile.addEventListener('change', () => {
        handleBackgroundUpload(bgImageFile.files[0]);
        bgImageFile.value = '';
      });
      document.getElementById('btn-save-background').addEventListener('click', saveBackground);
      document.getElementById('btn-clear-background').addEventListener('click', clearBackground);

      // Import/Export
      document.getElementById('btn-export-json').addEventListener('click', exportJson);
      document.getElementById('btn-import-json').addEventListener('click', () => {
        document.getElementById('import-file').click();
      });
      document.getElementById('import-file').addEventListener('change', (e) => {
        importJson(e.target.files[0]);
        e.target.value = '';
      });
      document.getElementById('btn-reset-defaults').addEventListener('click', () => {
        showConfirm('Reset to Defaults', 'This will delete all your custom tables and reset to default content. This cannot be undone.', () => {
          resetToDefaults();
          closeConfirm();
        });
      });

      // Images folder/path configuration
      document.getElementById('btn-set-image-path').addEventListener('click', () => {
        const path = document.getElementById('manual-image-path').value;
        setManualImagePath(path);
      });
      document.getElementById('manual-image-path').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          setManualImagePath(e.target.value);
        }
      });

      // Open images folder button (Electron only)
      document.getElementById('btn-open-images-folder').addEventListener('click', async () => {
        if (window.electronAPI && window.electronAPI.openImagesFolder) {
          const result = await window.electronAPI.openImagesFolder();
          if (result.success) {
            showToast('Opened images folder', 'success');
          }
        }
      });

      // Choose images folder button (Electron only)
      document.getElementById('btn-choose-images-folder').addEventListener('click', async () => {
        if (window.electronAPI && window.electronAPI.chooseImagesFolder) {
          const result = await window.electronAPI.chooseImagesFolder();
          if (result.success) {
            showToast('Images folder updated', 'success');
            updateImagesFolderStatus();
          } else if (!result.canceled) {
            showToast('Failed to set folder', 'error');
          }
        }
      });

      // Confirm modal
      document.getElementById('confirm-modal').querySelector('.modal-close').addEventListener('click', closeConfirm);
      document.getElementById('btn-confirm-cancel').addEventListener('click', closeConfirm);
      document.getElementById('btn-confirm-ok').addEventListener('click', () => {
        if (confirmCallback) confirmCallback();
      });

      // Input modal
      document.getElementById('input-modal').querySelector('.modal-close').addEventListener('click', closeInputModal);
      document.getElementById('btn-input-cancel').addEventListener('click', closeInputModal);
      document.getElementById('btn-input-ok').addEventListener('click', submitInputModal);
      document.getElementById('input-modal-value').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') submitInputModal();
        if (e.key === 'Escape') closeInputModal();
      });
      document.getElementById('input-modal').addEventListener('click', (e) => {
        if (e.target.id === 'input-modal') closeInputModal();
      });

      // Table Editor Panel
      document.getElementById('btn-close-editor-panel').addEventListener('click', closeTableEditorPanel);
      document.getElementById('btn-done-editing').addEventListener('click', closeTableEditorPanel);
      document.getElementById('panel-backdrop').addEventListener('click', closeTableEditorPanel);

      document.getElementById('btn-quick-add-entry').addEventListener('click', () => showInlineEditor());

      document.getElementById('btn-cancel-inline-edit').addEventListener('click', hideInlineEditor);
      document.getElementById('btn-save-inline-entry').addEventListener('click', saveInlineEntry);
      document.getElementById('btn-delete-inline-entry').addEventListener('click', () => {
        if (inlineEditingIndex !== null) deleteQuickEntry(inlineEditingIndex);
      });


      // Inline image upload
      const inlineImageUpload = document.getElementById('inline-image-upload');
      const inlineImageFile = document.getElementById('inline-image-file');
      inlineImageUpload.addEventListener('click', () => inlineImageFile.click());
      inlineImageUpload.addEventListener('dragover', (e) => { e.preventDefault(); });
      inlineImageUpload.addEventListener('drop', (e) => {
        e.preventDefault();
        handleInlineImageUpload(e.dataTransfer.files[0]);
      });
      inlineImageFile.addEventListener('change', () => {
        handleInlineImageUpload(inlineImageFile.files[0]);
        inlineImageFile.value = '';
      });
      document.getElementById('btn-inline-clear-image').addEventListener('click', clearInlineImage);
      document.getElementById('btn-inline-preview-card').addEventListener('click', previewInlineCard);

      // Keyboard
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          if (document.getElementById('confirm-modal').classList.contains('active')) {
            closeConfirm();
          } else if (document.getElementById('card-modal').classList.contains('active')) {
            closeCardModal();
          } else if (document.getElementById('welcome-modal').classList.contains('active')) {
            closeWelcomeModal();
          } else if (document.getElementById('table-editor-panel').classList.contains('active')) {
            if (!document.getElementById('inline-entry-editor').classList.contains('hidden')) {
              hideInlineEditor();
            } else {
              closeTableEditorPanel();
            }
          } else if (document.getElementById('settings-modal').classList.contains('active')) {
            closeSettings();
          }
        }
      });

      // Click outside modal to close
      [document.getElementById('card-modal'), document.getElementById('settings-modal'), document.getElementById('confirm-modal'), document.getElementById('welcome-modal')].forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            if (modal.id === 'card-modal') closeCardModal();
            else if (modal.id === 'settings-modal') closeSettings();
            else if (modal.id === 'confirm-modal') closeConfirm();
            else if (modal.id === 'welcome-modal') closeWelcomeModal();
          }
        });
      });
    }

    // ============================================
    // INITIALIZATION
    // ============================================
    function init() {
      loadData();
      initEventListeners();
      initAppSettings();
      renderAll();
      updateSelectionDisplay();
      updateImagesFolderStatus();
      showWelcomeModal();
    }

    // Start the app
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
